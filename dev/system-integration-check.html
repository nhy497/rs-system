<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»çµ±æ•´åˆé©—è­‰ - HKJRA v3.1</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { color: #667eea; margin-bottom: 20px; text-align: center; }
    h2 { color: #333; margin: 20px 0 10px; border-bottom: 2px solid #667eea; padding-bottom: 5px; }
    .check-item {
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #ccc;
      background: #f9f9f9;
    }
    .check-item.pass {
      border-left-color: #22c55e;
      background: #f0fdf4;
    }
    .check-item.fail {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    .check-item.warn {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    .icon { font-size: 1.2em; margin-right: 10px; }
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      margin: 10px 5px;
      transition: background 0.3s;
    }
    .btn:hover { background: #5568d3; }
    .btn:active { transform: scale(0.98); }
    .results { margin-top: 20px; }
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .summary h3 { margin-bottom: 10px; }
    .stats { display: flex; justify-content: space-around; margin-top: 15px; }
    .stat { text-align: center; }
    .stat-value { font-size: 2em; font-weight: bold; }
    .stat-label { font-size: 0.9em; opacity: 0.9; }
    code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” HKJRA ç³»çµ±æ•´åˆé©—è­‰å·¥å…· v3.1</h1>
    
    <div class="summary" id="summary">
      <h3>ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="total-checks">0</div>
          <div class="stat-label">ç¸½æª¢æŸ¥é …</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="pass-checks">0</div>
          <div class="stat-label">é€šé</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="fail-checks">0</div>
          <div class="stat-label">å¤±æ•—</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="rate-checks">0%</div>
          <div class="stat-label">é€šéç‡</div>
        </div>
      </div>
    </div>

    <div>
      <button class="btn" onclick="runAllChecks()">ğŸš€ åŸ·è¡Œå®Œæ•´æª¢æŸ¥</button>
      <button class="btn" onclick="checkStorage()">ğŸ’¾ æª¢æŸ¥å„²å­˜åº«</button>
      <button class="btn" onclick="checkSession()">ğŸ” æª¢æŸ¥æœƒè©±</button>
      <button class="btn" onclick="checkIntegration()">ğŸ”— æª¢æŸ¥æ•´åˆ</button>
      <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºçµæœ</button>
    </div>

    <div class="results" id="results"></div>
  </div>

  <script>
    let checksTotal = 0;
    let checksPass = 0;
    let checksFail = 0;

    function addCheck(title, status, details = '') {
      checksTotal++;
      if (status === 'pass') checksPass++;
      else if (status === 'fail') checksFail++;

      const icon = status === 'pass' ? 'âœ…' : status === 'fail' ? 'âŒ' : 'âš ï¸';
      const div = document.createElement('div');
      div.className = `check-item ${status}`;
      div.innerHTML = `
        <span class="icon">${icon}</span>
        <strong>${title}</strong>
        ${details ? `<div style="margin-top: 5px; color: #666; font-size: 0.9em;">${details}</div>` : ''}
      `;
      document.getElementById('results').appendChild(div);
      updateSummary();
    }

    function updateSummary() {
      document.getElementById('total-checks').textContent = checksTotal;
      document.getElementById('pass-checks').textContent = checksPass;
      document.getElementById('fail-checks').textContent = checksFail;
      const rate = checksTotal > 0 ? Math.round((checksPass / checksTotal) * 100) : 0;
      document.getElementById('rate-checks').textContent = rate + '%';
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      checksTotal = 0;
      checksPass = 0;
      checksFail = 0;
      updateSummary();
    }

    function addSection(title) {
      const section = document.createElement('h2');
      section.textContent = title;
      document.getElementById('results').appendChild(section);
    }

    // ==================== å„²å­˜åº«æª¢æŸ¥ ====================
    function checkStorage() {
      clearResults();
      addSection('ğŸ’¾ å„²å­˜åº«æª¢æŸ¥');

      // 1. localStorage å¯ç”¨æ€§
      try {
        const testKey = '__test__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        addCheck('localStorage å¯ç”¨æ€§', 'pass', 'localStorage è®€å¯«æ­£å¸¸');
      } catch (error) {
        addCheck('localStorage å¯ç”¨æ€§', 'fail', `éŒ¯èª¤: ${error.message}`);
      }

      // 2. æª¢æŸ¥æ ¸å¿ƒ keys
      const keys = [
        'rope-skip-checkpoints',
        'rope-skip-class-presets', 
        'rs-system-session',
        'current-user',
        'users'
      ];

      keys.forEach(key => {
        const value = localStorage.getItem(key);
        if (value !== null) {
          addCheck(`å„²å­˜é …: ${key}`, 'pass', `æ•¸æ“šé•·åº¦: ${value.length} å­—ç¬¦`);
        } else {
          addCheck(`å„²å­˜é …: ${key}`, 'warn', 'æš«ç„¡æ•¸æ“š (æ­£å¸¸ï¼Œæœªä½¿ç”¨é)');
        }
      });

      // 3. æª¢æŸ¥ç”¨æˆ¶æ•¸æ“šæ ¼å¼
      try {
        const usersData = localStorage.getItem('users');
        if (usersData) {
          const users = JSON.parse(usersData);
          if (Array.isArray(users)) {
            addCheck('ç”¨æˆ¶æ•¸æ“šæ ¼å¼', 'pass', `æ‰¾åˆ° ${users.length} å€‹ç”¨æˆ¶`);
          } else {
            addCheck('ç”¨æˆ¶æ•¸æ“šæ ¼å¼', 'fail', 'ç”¨æˆ¶æ•¸æ“šä¸æ˜¯æ•¸çµ„');
          }
        } else {
          addCheck('ç”¨æˆ¶æ•¸æ“šæ ¼å¼', 'warn', 'æš«ç„¡ç”¨æˆ¶æ•¸æ“š');
        }
      } catch (error) {
        addCheck('ç”¨æˆ¶æ•¸æ“šæ ¼å¼', 'fail', `è§£æå¤±æ•—: ${error.message}`);
      }

      // 4. æª¢æŸ¥èª²å ‚è¨˜éŒ„æ ¼å¼
      try {
        const checkpointsData = localStorage.getItem('rope-skip-checkpoints');
        if (checkpointsData) {
          try {
            const decoded = JSON.parse(atob(checkpointsData));
            if (Array.isArray(decoded)) {
              addCheck('èª²å ‚è¨˜éŒ„æ ¼å¼ (Base64)', 'pass', `æ‰¾åˆ° ${decoded.length} ç­†è¨˜éŒ„`);
            } else {
              addCheck('èª²å ‚è¨˜éŒ„æ ¼å¼', 'fail', 'æ•¸æ“šä¸æ˜¯æ•¸çµ„');
            }
          } catch (decodeError) {
            const direct = JSON.parse(checkpointsData);
            if (Array.isArray(direct)) {
              addCheck('èª²å ‚è¨˜éŒ„æ ¼å¼ (ç›´æ¥)', 'pass', `æ‰¾åˆ° ${direct.length} ç­†è¨˜éŒ„ (æœªç·¨ç¢¼)`);
            }
          }
        } else {
          addCheck('èª²å ‚è¨˜éŒ„æ ¼å¼', 'warn', 'æš«ç„¡èª²å ‚è¨˜éŒ„');
        }
      } catch (error) {
        addCheck('èª²å ‚è¨˜éŒ„æ ¼å¼', 'fail', `æª¢æŸ¥å¤±æ•—: ${error.message}`);
      }

      // 5. å„²å­˜å®¹é‡æª¢æŸ¥
      try {
        let totalSize = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length;
          }
        }
        const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
        if (sizeMB < 4) {
          addCheck('å„²å­˜å®¹é‡', 'pass', `å·²ä½¿ç”¨: ${sizeMB} MB / 5 MB`);
        } else {
          addCheck('å„²å­˜å®¹é‡', 'warn', `å·²ä½¿ç”¨: ${sizeMB} MB / 5 MB (æ¥è¿‘ä¸Šé™)`);
        }
      } catch (error) {
        addCheck('å„²å­˜å®¹é‡', 'fail', `æª¢æŸ¥å¤±æ•—: ${error.message}`);
      }
    }

    // ==================== æœƒè©±æª¢æŸ¥ ====================
    function checkSession() {
      clearResults();
      addSection('ğŸ” æœƒè©±ç³»çµ±æª¢æŸ¥');

      // 1. æª¢æŸ¥æœƒè©±æ•¸æ“š
      try {
        const sessionData = localStorage.getItem('rs-system-session');
        if (sessionData) {
          const session = JSON.parse(sessionData);
          addCheck('æœƒè©±æ•¸æ“šå­˜åœ¨', 'pass', `æœƒè©± ID: ${session.sessionId || 'æœªçŸ¥'}`);

          // æª¢æŸ¥å¿…è¦æ¬„ä½
          const requiredFields = ['userId', 'sessionId', 'expiresAt'];
          requiredFields.forEach(field => {
            if (session[field]) {
              addCheck(`æœƒè©±æ¬„ä½: ${field}`, 'pass', `å€¼: ${session[field]}`);
            } else {
              addCheck(`æœƒè©±æ¬„ä½: ${field}`, 'fail', 'æ¬„ä½ç¼ºå¤±');
            }
          });

          // æª¢æŸ¥éæœŸæ™‚é–“
          if (session.expiresAt) {
            const now = Date.now();
            if (now < session.expiresAt) {
              const hoursLeft = Math.round((session.expiresAt - now) / 3600000);
              addCheck('æœƒè©±æœ‰æ•ˆæ€§', 'pass', `å‰©é¤˜æ™‚é–“: ${hoursLeft} å°æ™‚`);
            } else {
              addCheck('æœƒè©±æœ‰æ•ˆæ€§', 'fail', 'æœƒè©±å·²éæœŸ');
            }
          }
        } else {
          addCheck('æœƒè©±æ•¸æ“šå­˜åœ¨', 'warn', 'æœªç™»å…¥æˆ–æœƒè©±å·²æ¸…é™¤');
        }
      } catch (error) {
        addCheck('æœƒè©±æ•¸æ“šæª¢æŸ¥', 'fail', `éŒ¯èª¤: ${error.message}`);
      }

      // 2. æª¢æŸ¥ç•¶å‰ç”¨æˆ¶
      try {
        const userData = localStorage.getItem('current-user');
        if (userData) {
          const user = JSON.parse(userData);
          addCheck('ç•¶å‰ç”¨æˆ¶æ•¸æ“š', 'pass', `ç”¨æˆ¶å: ${user.username || 'æœªçŸ¥'}`);
          
          if (user.username) {
            addCheck('ç”¨æˆ¶å', 'pass', user.username);
          }
          if (user.role) {
            addCheck('ç”¨æˆ¶è§’è‰²', 'pass', user.role);
          }
          if (user.id) {
            addCheck('ç”¨æˆ¶ ID', 'pass', user.id);
          }
        } else {
          addCheck('ç•¶å‰ç”¨æˆ¶æ•¸æ“š', 'warn', 'æœªç™»å…¥æˆ–ç”¨æˆ¶æ•¸æ“šå·²æ¸…é™¤');
        }
      } catch (error) {
        addCheck('ç•¶å‰ç”¨æˆ¶æª¢æŸ¥', 'fail', `éŒ¯èª¤: ${error.message}`);
      }

      // 3. æœƒè©±èˆ‡ç”¨æˆ¶ä¸€è‡´æ€§
      try {
        const sessionData = localStorage.getItem('rs-system-session');
        const userData = localStorage.getItem('current-user');
        
        if (sessionData && userData) {
          const session = JSON.parse(sessionData);
          const user = JSON.parse(userData);
          
          if (session.userId === user.id) {
            addCheck('æœƒè©±ç”¨æˆ¶ä¸€è‡´æ€§', 'pass', 'userId åŒ¹é…');
          } else {
            addCheck('æœƒè©±ç”¨æˆ¶ä¸€è‡´æ€§', 'fail', `ä¸åŒ¹é…: ${session.userId} vs ${user.id}`);
          }
        } else {
          addCheck('æœƒè©±ç”¨æˆ¶ä¸€è‡´æ€§', 'warn', 'ç„¡æ³•æª¢æŸ¥ (æ•¸æ“šä¸å®Œæ•´)');
        }
      } catch (error) {
        addCheck('ä¸€è‡´æ€§æª¢æŸ¥', 'fail', `éŒ¯èª¤: ${error.message}`);
      }
    }

    // ==================== æ•´åˆæª¢æŸ¥ ====================
    function checkIntegration() {
      clearResults();
      addSection('ğŸ”— ç³»çµ±æ•´åˆæª¢æŸ¥');

      // 1. æª¢æŸ¥å…¨å±€å°è±¡
      const globalObjects = [
        'localStorage',
        'sessionStorage',
        'JSON',
        'atob',
        'btoa'
      ];

      globalObjects.forEach(obj => {
        if (typeof window[obj] !== 'undefined') {
          addCheck(`å…¨å±€å°è±¡: ${obj}`, 'pass', 'å¯ç”¨');
        } else {
          addCheck(`å…¨å±€å°è±¡: ${obj}`, 'fail', 'ä¸å¯ç”¨');
        }
      });

      // 2. æª¢æŸ¥ PouchDB
      if (typeof PouchDB !== 'undefined') {
        addCheck('PouchDB åº«', 'pass', 'PouchDB å·²åŠ è¼‰');
      } else {
        addCheck('PouchDB åº«', 'warn', 'PouchDB æœªåŠ è¼‰ (åƒ…éœ€è¦æ™‚)');
      }

      // 3. æª¢æŸ¥é é¢éˆæ¥
      const pages = [
        { name: 'index.html', desc: 'ä¸»æ‡‰ç”¨é é¢' },
        { name: 'login.html', desc: 'ç™»å…¥é é¢' },
        { name: 'system-test.html', desc: 'ç³»çµ±æ¸¬è©¦é é¢' }
      ];

      addCheck('é é¢çµæ§‹', 'pass', `ç³»çµ±åŒ…å« ${pages.length} å€‹æ ¸å¿ƒé é¢`);

      // 4. æª¢æŸ¥ localStorage éµä¸€è‡´æ€§
      const expectedKeys = [
        'rope-skip-checkpoints',
        'rope-skip-class-presets',
        'rs-system-session',
        'current-user',
        'users'
      ];

      const actualKeys = Object.keys(localStorage);
      const matchingKeys = expectedKeys.filter(key => actualKeys.includes(key));
      
      if (matchingKeys.length > 0) {
        addCheck('å„²å­˜éµä¸€è‡´æ€§', 'pass', `${matchingKeys.length}/${expectedKeys.length} å€‹éµå­˜åœ¨`);
      } else {
        addCheck('å„²å­˜éµä¸€è‡´æ€§', 'warn', 'æš«ç„¡æ•¸æ“š (é¦–æ¬¡ä½¿ç”¨)');
      }

      // 5. æ•¸æ“šæµå‘æ¸¬è©¦
      try {
        // æ¨¡æ“¬æ•¸æ“šå¯«å…¥
        const testData = {
          test: true,
          timestamp: Date.now()
        };
        const testKey = '__integration_test__';
        localStorage.setItem(testKey, JSON.stringify(testData));
        
        // è®€å–é©—è­‰
        const readData = JSON.parse(localStorage.getItem(testKey));
        if (readData.test === true && readData.timestamp === testData.timestamp) {
          addCheck('æ•¸æ“šæµå‘æ¸¬è©¦', 'pass', 'è®€å¯«å®Œæ•´æ€§é©—è­‰é€šé');
        } else {
          addCheck('æ•¸æ“šæµå‘æ¸¬è©¦', 'fail', 'æ•¸æ“šä¸ä¸€è‡´');
        }
        
        // æ¸…ç†
        localStorage.removeItem(testKey);
      } catch (error) {
        addCheck('æ•¸æ“šæµå‘æ¸¬è©¦', 'fail', `éŒ¯èª¤: ${error.message}`);
      }

      // 6. Base64 ç·¨ç¢¼æ¸¬è©¦
      try {
        const originalData = { test: 'æ¸¬è©¦æ•¸æ“š', number: 12345 };
        const encoded = btoa(JSON.stringify(originalData));
        const decoded = JSON.parse(atob(encoded));
        
        if (JSON.stringify(originalData) === JSON.stringify(decoded)) {
          addCheck('Base64 ç·¨ç¢¼/è§£ç¢¼', 'pass', 'æ•¸æ“šå®Œæ•´æ€§ä¿æŒ');
        } else {
          addCheck('Base64 ç·¨ç¢¼/è§£ç¢¼', 'fail', 'æ•¸æ“šä¸ä¸€è‡´');
        }
      } catch (error) {
        addCheck('Base64 ç·¨ç¢¼/è§£ç¢¼', 'fail', `éŒ¯èª¤: ${error.message}`);
      }
    }

    // ==================== å®Œæ•´æª¢æŸ¥ ====================
    function runAllChecks() {
      clearResults();
      
      addSection('ğŸš€ åŸ·è¡Œå®Œæ•´ç³»çµ±æª¢æŸ¥');
      
      // å„²å­˜åº«æª¢æŸ¥
      checkStorage();
      
      // æœƒè©±æª¢æŸ¥
      setTimeout(() => {
        checkSession();
      }, 100);
      
      // æ•´åˆæª¢æŸ¥
      setTimeout(() => {
        checkIntegration();
        
        // æœ€çµ‚ç¸½çµ
        setTimeout(() => {
          addSection('ğŸ“Š æª¢æŸ¥å®Œæˆ');
          const rate = checksTotal > 0 ? Math.round((checksPass / checksTotal) * 100) : 0;
          
          if (rate >= 90) {
            addCheck('ç³»çµ±ç‹€æ…‹', 'pass', `é€šéç‡ ${rate}% - ç³»çµ±é‹ä½œæ­£å¸¸ âœ¨`);
          } else if (rate >= 70) {
            addCheck('ç³»çµ±ç‹€æ…‹', 'warn', `é€šéç‡ ${rate}% - éƒ¨åˆ†åŠŸèƒ½éœ€è¦æ³¨æ„ âš ï¸`);
          } else {
            addCheck('ç³»çµ±ç‹€æ…‹', 'fail', `é€šéç‡ ${rate}% - ç³»çµ±éœ€è¦æª¢æŸ¥ âŒ`);
          }
        }, 100);
      }, 200);
    }

    // é é¢åŠ è¼‰æ™‚è‡ªå‹•åŸ·è¡Œ
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ” ç³»çµ±æ•´åˆé©—è­‰å·¥å…·å·²å°±ç·’');
      console.log('ğŸ’¡ é»æ“ŠæŒ‰éˆ•é–‹å§‹æª¢æŸ¥ï¼Œæˆ–ç›´æ¥åŸ·è¡Œ runAllChecks()');
    });
  </script>
</body>
</html>

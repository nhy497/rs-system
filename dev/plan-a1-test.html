<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLAN-A1 æ¸¬è©¦ - è·¨æ¨™ç±¤é å³æ™‚åŒæ­¥</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 { 
      font-size: 2.5em; 
      margin-bottom: 10px; 
    }
    
    .header p { 
      opacity: 0.95; 
      font-size: 1.1em;
    }
    
    .content {
      padding: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section p {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover { background: #5568d3; }
    
    .btn-success {
      background: #11998e;
      color: white;
    }
    
    .btn-success:hover { background: #0d7a6a; }
    
    .btn-danger {
      background: #ee0979;
      color: white;
    }
    
    .btn-danger:hover { background: #c60661; }
    
    .btn-warning {
      background: #f2994a;
      color: white;
    }
    
    .btn-warning:hover { background: #d67c2f; }
    
    .output {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.95em;
      line-height: 1.6;
    }
    
    .log-line {
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .log-line:last-child {
      border-bottom: none;
    }
    
    .log-time {
      color: #999;
      margin-right: 10px;
      font-weight: 600;
    }
    
    .log-icon {
      margin-right: 5px;
    }
    
    .log-success { color: #11998e; }
    .log-error { color: #ee0979; }
    .log-warn { color: #f2994a; }
    .log-info { color: #667eea; }
    
    .status-display {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .status-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }
    
    .status-item label {
      display: block;
      font-weight: 600;
      color: #667eea;
      font-size: 0.85em;
      margin-bottom: 5px;
    }
    
    .status-item .value {
      font-size: 1.1em;
      color: #333;
      font-family: 'Courier New', monospace;
    }
    
    .tab-info {
      background: #d1ecf1;
      color: #0c5460;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #0c5460;
    }
    
    .tab-info strong {
      display: block;
      margin-bottom: 5px;
    }
    
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-box {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
    }
    
    .stat-box .label {
      color: #999;
      font-size: 0.85em;
      margin-bottom: 8px;
    }
    
    .stat-box .value {
      font-size: 2em;
      font-weight: 700;
      color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“¡ PLAN-A1 æ¸¬è©¦</h1>
      <p>è·¨æ¨™ç±¤é å³æ™‚åŒæ­¥ (BroadcastChannel API)</p>
    </div>
    
    <div class="content">
      <div class="tab-info">
        <strong>ğŸ” æ¸¬è©¦èªªæ˜ï¼š</strong>
        <p>æ­¤é é¢æ¸¬è©¦ PLAN-A1 åŠŸèƒ½ - è·¨æ¨™ç±¤é å³æ™‚åŒæ­¥ã€‚æ‰“é–‹å¤šå€‹æ¨™ç±¤é æ™‚ï¼Œåœ¨ä¸€å€‹æ¨™ç±¤é é€²è¡Œæ“ä½œï¼ˆæ–°å¢/ç·¨è¼¯èª²ç¨‹è¨˜éŒ„ï¼‰æ‡‰è©²æœƒè‡ªå‹•åŒæ­¥åˆ°å…¶ä»–æ¨™ç±¤é ã€‚</p>
      </div>
      
      <!-- çµ±è¨ˆä¿¡æ¯ -->
      <div class="stats-grid" id="stats-container">
        <div class="stat-box">
          <div class="label">BroadcastChannel</div>
          <div class="value" id="stat-channel">âŒ</div>
        </div>
        <div class="stat-box">
          <div class="label">ç•¶å‰æ•¸æ“šç­†æ•¸</div>
          <div class="value" id="stat-records">0</div>
        </div>
        <div class="stat-box">
          <div class="label">å·²åŒæ­¥</div>
          <div class="value" id="stat-synced">0</div>
        </div>
        <div class="stat-box">
          <div class="label">æ¸¬è©¦ç‹€æ…‹</div>
          <div class="value" id="stat-status">å¾…æ¸¬</div>
        </div>
      </div>
      
      <!-- æª¢æ¸¬åŠŸèƒ½ -->
      <div class="section">
        <h2>
          <span>âœ…</span> 1. æª¢æ¸¬ BroadcastChannel æ”¯æ´
        </h2>
        <p>æª¢æŸ¥ç•¶å‰ç€è¦½å™¨æ˜¯å¦æ”¯æ´ BroadcastChannel API</p>
        <div class="controls">
          <button class="btn-primary" onclick="testBroadcastChannelSupport()">
            <span>ğŸ”</span> æª¢æ¸¬æ”¯æ´
          </button>
          <button class="btn-primary" onclick="showBroadcastChannelInfo()">
            <span>â„¹ï¸</span> é¡¯ç¤ºä¿¡æ¯
          </button>
        </div>
        <div class="output" id="detect-output"></div>
      </div>
      
      <!-- åˆå§‹åŒ–æ¸¬è©¦ -->
      <div class="section">
        <h2>
          <span>âš™ï¸</span> 2. åˆå§‹åŒ– BroadcastChannel
        </h2>
        <p>åˆå§‹åŒ– BroadcastChannel ä¸¦è¨­ç½®ç›£è½å™¨</p>
        <div class="controls">
          <button class="btn-success" onclick="initBroadcastChannel()">
            <span>âš™ï¸</span> åˆå§‹åŒ–
          </button>
          <button class="btn-primary" onclick="showChannelStatus()">
            <span>ğŸ“Š</span> é¡¯ç¤ºç‹€æ…‹
          </button>
        </div>
        <div class="output" id="init-output"></div>
        <div class="status-display" id="init-status"></div>
      </div>
      
      <!-- æ•¸æ“šæ¸¬è©¦ -->
      <div class="section">
        <h2>
          <span>ğŸ’¾</span> 3. æ•¸æ“šåŒæ­¥æ¸¬è©¦
        </h2>
        <p>æ¸¬è©¦èª²ç¨‹è¨˜éŒ„çš„ä¿å­˜å’Œè·¨æ¨™ç±¤é åŒæ­¥</p>
        <div class="controls">
          <button class="btn-success" onclick="addTestRecord()">
            <span>â•</span> æ–°å¢èª²ç¨‹è¨˜éŒ„
          </button>
          <button class="btn-primary" onclick="listAllRecords()">
            <span>ğŸ“‹</span> åˆ—å‡ºæ‰€æœ‰è¨˜éŒ„
          </button>
          <button class="btn-warning" onclick="checkSyncStatus()">
            <span>ğŸ”„</span> æª¢æŸ¥åŒæ­¥ç‹€æ…‹
          </button>
          <button class="btn-danger" onclick="clearTestData()">
            <span>ğŸ—‘ï¸</span> æ¸…é™¤æ¸¬è©¦æ•¸æ“š
          </button>
        </div>
        <div class="output" id="data-output"></div>
      </div>
      
      <!-- å¯¦æ™‚ç›£è½ -->
      <div class="section">
        <h2>
          <span>ğŸ‘‚</span> 4. å¯¦æ™‚ç›£è½å™¨
        </h2>
        <p>ç›£è½ BroadcastChannel æ¶ˆæ¯ï¼Œå¯¦æ™‚é¡¯ç¤ºè·¨æ¨™ç±¤é åŒæ­¥äº‹ä»¶</p>
        <div class="controls">
          <button class="btn-success" onclick="startListening()">
            <span>â–¶ï¸</span> é–‹å§‹ç›£è½
          </button>
          <button class="btn-danger" onclick="stopListening()">
            <span>â¹ï¸</span> åœæ­¢ç›£è½
          </button>
          <button class="btn-primary" onclick="sendTestMessage()">
            <span>ğŸ“¤</span> ç™¼é€æ¸¬è©¦æ¶ˆæ¯
          </button>
        </div>
        <div class="output" id="listener-output"></div>
      </div>
      
      <!-- å¤šæ¨™ç±¤é æ¸¬è©¦æŒ‡å— -->
      <div class="section">
        <h2>
          <span>ğŸ¯</span> 5. å¤šæ¨™ç±¤é æ¸¬è©¦æŒ‡å—
        </h2>
        <p>æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ¸¬è©¦è·¨æ¨™ç±¤é åŒæ­¥åŠŸèƒ½ï¼š</p>
        <ol style="margin-left: 20px; color: #666; line-height: 1.8;">
          <li>æ‰“é–‹æ­¤é é¢ï¼ˆä½œç‚ºæ¨™ç±¤é  Aï¼‰</li>
          <li>é»æ“Šã€Œæ–°å¢èª²ç¨‹è¨˜éŒ„ã€æ·»åŠ ä¸€äº›æ¸¬è©¦æ•¸æ“š</li>
          <li>åœ¨æ–°æ¨™ç±¤é æ‰“é–‹ç›¸åŒçš„æ¸¬è©¦é é¢æˆ–ä¸»æ‡‰ç”¨ï¼ˆä½œç‚ºæ¨™ç±¤é  Bï¼‰</li>
          <li>åœ¨æ¨™ç±¤é  A ä¸­å†æ¬¡é»æ“Šã€Œæ–°å¢èª²ç¨‹è¨˜éŒ„ã€</li>
          <li>åˆ‡æ›åˆ°æ¨™ç±¤é  Bï¼Œæª¢æŸ¥æ•¸æ“šæ˜¯å¦è‡ªå‹•æ›´æ–°</li>
          <li>å¦‚æœæ•¸æ“šè‡ªå‹•åŒæ­¥ï¼Œèªªæ˜ PLAN-A1 åŠŸèƒ½æ­£å¸¸ âœ…</li>
        </ol>
        <div class="controls" style="margin-top: 20px;">
          <button class="btn-primary" onclick="openNewWindow()">
            <span>ğŸªŸ</span> æ‰“é–‹æ–°çª—å£é€²è¡Œæ¸¬è©¦
          </button>
        </div>
      </div>
      
      <!-- å®Œæ•´æ¸¬è©¦ -->
      <div class="section">
        <h2>
          <span>ğŸ§ª</span> 6. å®Œæ•´æ¸¬è©¦å¥—ä»¶
        </h2>
        <p>åŸ·è¡Œå®Œæ•´çš„ PLAN-A1 æ¸¬è©¦å¥—ä»¶</p>
        <div class="controls">
          <button class="btn-success" onclick="runFullTest()">
            <span>â–¶ï¸</span> é‹è¡Œå®Œæ•´æ¸¬è©¦
          </button>
          <button class="btn-primary" onclick="generateReport()">
            <span>ğŸ“„</span> ç”Ÿæˆå ±å‘Š
          </button>
          <button class="btn-danger" onclick="resetTest()">
            <span>ğŸ”„</span> é‡ç½®æ¸¬è©¦
          </button>
        </div>
        <div class="output" id="full-test-output"></div>
      </div>
    </div>
  </div>
  
  <script>
    // ==================== å…¨å±€è®Šæ•¸ ====================
    let channel = null;
    let isListening = false;
    let testResults = {
      broadcastChannelSupported: false,
      channelInitialized: false,
      messagesReceived: 0,
      recordsSynced: 0,
      tests: []
    };
    
    const TEST_KEY = 'dev-rope-skip-checkpoints';
    
    // ==================== å·¥å…·å‡½æ•¸ ====================
    
    function log(outputId, message, type = 'info') {
      const output = document.getElementById(outputId);
      if (!output) return;
      
      const time = new Date().toLocaleTimeString('zh-TW');
      const icon = { success: 'âœ…', error: 'âŒ', warn: 'âš ï¸', info: 'â„¹ï¸' }[type] || 'â„¹ï¸';
      const className = `log-line log-${type}`;
      
      const line = document.createElement('div');
      line.className = className;
      line.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-icon">${icon}</span> ${escapeHtml(message)}`;
      
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function updateStat(statId, value) {
      const stat = document.getElementById(statId);
      if (stat) stat.textContent = value;
    }
    
    // ==================== æª¢æ¸¬åŠŸèƒ½ ====================
    
    function testBroadcastChannelSupport() {
      const output = document.getElementById('detect-output');
      output.innerHTML = '';
      
      log('detect-output', 'æ­£åœ¨æª¢æ¸¬ BroadcastChannel æ”¯æ´...', 'info');
      
      const supported = typeof BroadcastChannel !== 'undefined';
      testResults.broadcastChannelSupported = supported;
      
      if (supported) {
        log('detect-output', 'âœ… BroadcastChannel å·²æ”¯æ´', 'success');
        updateStat('stat-channel', 'âœ… æ”¯æ´');
      } else {
        log('detect-output', 'âŒ BroadcastChannel ä¸è¢«æ”¯æ´', 'error');
        updateStat('stat-channel', 'âŒ ä¸æ”¯æ´');
      }
      
      log('detect-output', `ç€è¦½å™¨ä¿¡æ¯: ${navigator.userAgent.substring(0, 60)}...`, 'info');
    }
    
    function showBroadcastChannelInfo() {
      log('detect-output', 'ç€è¦½å™¨ API ä¿¡æ¯ï¼š', 'info');
      log('detect-output', `BroadcastChannel: ${typeof BroadcastChannel}`, 'info');
      log('detect-output', `localStorage: ${typeof localStorage}`, 'info');
      log('detect-output', `Worker: ${typeof Worker}`, 'info');
    }
    
    // ==================== åˆå§‹åŒ–åŠŸèƒ½ ====================
    
    function initBroadcastChannel() {
      const output = document.getElementById('init-output');
      const status = document.getElementById('init-status');
      output.innerHTML = '';
      status.innerHTML = '';
      
      log('init-output', 'æ­£åœ¨åˆå§‹åŒ–åŒæ­¥æ©Ÿåˆ¶...', 'info');
      
      // æª¢æŸ¥ BroadcastChannel æ”¯æ´
      const hasBroadcastChannel = typeof BroadcastChannel !== 'undefined';
      
      if (!hasBroadcastChannel) {
        log('init-output', 'âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´ BroadcastChannelï¼Œä½¿ç”¨ localStorage storage äº‹ä»¶ä½œç‚ºå‚™é¸æ©Ÿåˆ¶', 'warn');
        log('init-output', 'ä½¿ç”¨å‚™é¸æ–¹æ¡ˆ: localStorage storage äº‹ä»¶', 'info');
        
        // ä½¿ç”¨ storage äº‹ä»¶ä½œç‚ºå‚™é¸æ©Ÿåˆ¶
        setupStorageSync();
        testResults.channelInitialized = true;
        return;
      }
      
      try {
        log('init-output', 'æ­£åœ¨åˆå§‹åŒ– BroadcastChannel...', 'info');
        
        channel = new BroadcastChannel('rs-system-sync');
        testResults.channelInitialized = true;
        
        log('init-output', 'âœ… BroadcastChannel åˆå§‹åŒ–æˆåŠŸ', 'success');
        log('init-output', 'å·²å‰µå»ºé€šé“: rs-system-sync', 'info');
        
        // é¡¯ç¤ºç‹€æ…‹
        const statusHtml = `
          <div class="status-item">
            <label>é€šé“åç¨±</label>
            <div class="value">rs-system-sync</div>
          </div>
          <div class="status-item">
            <label>é€šé“ç‹€æ…‹</label>
            <div class="value">âœ… å·²åˆå§‹åŒ–</div>
          </div>
          <div class="status-item">
            <label>æ¶ˆæ¯ç›£è½</label>
            <div class="value">${isListening ? 'âœ… å·²å•Ÿç”¨' : 'âŒ æœªå•Ÿç”¨'}</div>
          </div>
          <div class="status-item">
            <label>æ¥æ”¶æ¶ˆæ¯æ•¸</label>
            <div class="value">${testResults.messagesReceived}</div>
          </div>
        `;
        status.innerHTML = statusHtml;
        
      } catch (error) {
        log('init-output', `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    function showChannelStatus() {
      const status = document.getElementById('init-status');
      status.innerHTML = '';
      
      const statusHtml = `
        <div class="status-item">
          <label>BroadcastChannel æ”¯æ´</label>
          <div class="value">${testResults.broadcastChannelSupported ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´'}</div>
        </div>
        <div class="status-item">
          <label>é€šé“åˆå§‹åŒ–</label>
          <div class="value">${testResults.channelInitialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}</div>
        </div>
        <div class="status-item">
          <label>ç›£è½ç‹€æ…‹</label>
          <div class="value">${isListening ? 'âœ… ç›£è½ä¸­' : 'âŒ æœªç›£è½'}</div>
        </div>
        <div class="status-item">
          <label>æ¥æ”¶æ¶ˆæ¯</label>
          <div class="value">${testResults.messagesReceived}</div>
        </div>
        <div class="status-item">
          <label>åŒæ­¥è¨˜éŒ„</label>
          <div class="value">${testResults.recordsSynced}</div>
        </div>
      `;
      status.innerHTML = statusHtml;
    }
    
    // ==================== æ•¸æ“šæ¸¬è©¦åŠŸèƒ½ ====================
    
    function addTestRecord() {
      const output = document.getElementById('data-output');
      output.innerHTML = '';
      
      try {
        const records = JSON.parse(localStorage.getItem(TEST_KEY) || '[]');
        const newRecord = {
          id: Date.now(),
          className: `æ¸¬è©¦ç­ç´š ${records.length + 1}`,
          date: new Date().toLocaleDateString('zh-TW'),
          content: `è‡ªå‹•ç”Ÿæˆçš„æ¸¬è©¦å…§å®¹ - ${new Date().toLocaleTimeString('zh-TW')}`,
          timestamp: Date.now()
        };
        
        records.push(newRecord);
        localStorage.setItem(TEST_KEY, JSON.stringify(records));
        
        log('data-output', `âœ… èª²ç¨‹è¨˜éŒ„å·²æ·»åŠ  - ${newRecord.className}`, 'success');
        log('data-output', `è¨˜éŒ„ ID: ${newRecord.id}`, 'info');
        log('data-output', `æ™‚é–“: ${newRecord.date} ${new Date().toLocaleTimeString('zh-TW')}`, 'info');
        
        // å»£æ’­æ¶ˆæ¯åˆ°å…¶ä»–æ¨™ç±¤é 
        if (channel) {
          channel.postMessage({
            type: 'storage-updated',
            recordId: newRecord.id,
            className: newRecord.className,
            timestamp: Date.now()
          });
          log('data-output', 'ğŸ“¤ å·²å»£æ’­åŒæ­¥æ¶ˆæ¯åˆ°å…¶ä»–æ¨™ç±¤é ', 'info');
        }
        
        updateStat('stat-records', records.length);
        testResults.recordsSynced++;
        updateStat('stat-synced', testResults.recordsSynced);
        
      } catch (error) {
        log('data-output', `âŒ æ·»åŠ è¨˜éŒ„å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    function listAllRecords() {
      const output = document.getElementById('data-output');
      output.innerHTML = '';
      
      try {
        const records = JSON.parse(localStorage.getItem(TEST_KEY) || '[]');
        
        if (records.length === 0) {
          log('data-output', 'âš ï¸ æ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²ç¨‹è¨˜éŒ„', 'warn');
          return;
        }
        
        log('data-output', `ğŸ“‹ å…±æ‰¾åˆ° ${records.length} ç­†èª²ç¨‹è¨˜éŒ„:`, 'info');
        records.forEach((record, index) => {
          log('data-output', `${index + 1}. ${record.className} (${record.date})`, 'info');
        });
        
        updateStat('stat-records', records.length);
        
      } catch (error) {
        log('data-output', `âŒ åˆ—è¡¨å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    function checkSyncStatus() {
      const output = document.getElementById('data-output');
      output.innerHTML = '';
      
      log('data-output', 'ğŸ” æª¢æŸ¥åŒæ­¥ç‹€æ…‹...', 'info');
      
      const records = JSON.parse(localStorage.getItem(TEST_KEY) || '[]');
      log('data-output', `âœ… ç•¶å‰å­˜å„²è¨˜éŒ„: ${records.length} ç­†`, 'success');
      log('data-output', `âœ… å·²åŒæ­¥è¨˜éŒ„: ${testResults.recordsSynced} ç­†`, 'success');
      
      if (channel) {
        log('data-output', 'âœ… BroadcastChannel å·²é€£æ¥', 'success');
      } else {
        log('data-output', 'âš ï¸ BroadcastChannel æœªé€£æ¥', 'warn');
      }
    }
    
    function clearTestData() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¸¬è©¦æ•¸æ“šå—ï¼Ÿ')) {
        localStorage.removeItem(TEST_KEY);
        document.getElementById('data-output').innerHTML = '';
        log('data-output', 'âœ… æ‰€æœ‰æ¸¬è©¦æ•¸æ“šå·²æ¸…é™¤', 'success');
        updateStat('stat-records', 0);
        testResults.recordsSynced = 0;
        updateStat('stat-synced', 0);
      }
    }
    
    // ==================== å‚™é¸æ–¹æ¡ˆ: Storage äº‹ä»¶åŒæ­¥ ====================
    
    function setupStorageSync() {
      window.addEventListener('storage', (event) => {
        if (event.key === TEST_KEY) {
          log('listener-output', `ğŸ“¨ æª¢æ¸¬åˆ° storage è®ŠåŒ– (ä¾†è‡ªå…¶ä»–æ¨™ç±¤é )`, 'info');
          testResults.messagesReceived++;
          updateStat('stat-synced', testResults.messagesReceived);
          
          // æ›´æ–°ç•¶å‰é é¢çš„æ•¸æ“š
          const records = JSON.parse(event.newValue || '[]');
          updateStat('stat-records', records.length);
          log('listener-output', `âœ… å·²åŒæ­¥ ${records.length} ç­†è¨˜éŒ„`, 'success');
        }
      });
      log('listener-output', 'âœ… Storage äº‹ä»¶ç›£è½å·²è¨­ç½®', 'success');
    }
    
    // ==================== ç›£è½åŠŸèƒ½ ====================
    
    function startListening() {
      const output = document.getElementById('listener-output');
      output.innerHTML = '';
      
      if (!testResults.channelInitialized) {
        log('listener-output', 'âŒ è«‹å…ˆåˆå§‹åŒ–åŒæ­¥æ©Ÿåˆ¶', 'error');
        return;
      }
      
      isListening = true;
      
      const hasBroadcastChannel = typeof BroadcastChannel !== 'undefined';
      
      if (hasBroadcastChannel && channel) {
        log('listener-output', 'â–¶ï¸ é–‹å§‹ç›£è½ BroadcastChannel æ¶ˆæ¯...', 'success');
        channel.onmessage = (event) => {
          testResults.messagesReceived++;
          const message = event.data;
          log('listener-output', `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
          updateStat('stat-synced', testResults.messagesReceived);
        };
      } else {
        log('listener-output', 'â–¶ï¸ é–‹å§‹ç›£è½ Storage äº‹ä»¶...', 'success');
        setupStorageSync();
      }
    }
    
    function stopListening() {
      if (channel) {
        channel.onmessage = null;
        isListening = false;
        log('listener-output', 'â¹ï¸ å·²åœæ­¢ç›£è½', 'warn');
      }
    }
    
    function sendTestMessage() {
      const output = document.getElementById('listener-output');
      output.innerHTML = '';
      
      if (!testResults.channelInitialized) {
        log('listener-output', 'âŒ è«‹å…ˆåˆå§‹åŒ–åŒæ­¥æ©Ÿåˆ¶', 'error');
        return;
      }
      
      const hasBroadcastChannel = typeof BroadcastChannel !== 'undefined';
      const testMessage = {
        type: 'test-message',
        timestamp: Date.now(),
        sender: 'test-page',
        content: 'é€™æ˜¯ä¸€æ¢æ¸¬è©¦æ¶ˆæ¯'
      };
      
      if (hasBroadcastChannel && channel) {
        channel.postMessage(testMessage);
        log('listener-output', `ğŸ“¤ å·²ç™¼é€ BroadcastChannel æ¶ˆæ¯: ${JSON.stringify(testMessage)}`, 'success');
      } else {
        // ä½¿ç”¨ storage äº‹ä»¶æ¨¡æ“¬è·¨æ¨™ç±¤é é€šè¨Š
        const testKey = `rs-system-test-${Date.now()}`;
        localStorage.setItem(testKey, JSON.stringify(testMessage));
        log('listener-output', `ğŸ“¤ å·²ç™¼é€ Storage äº‹ä»¶æ¶ˆæ¯: ${JSON.stringify(testMessage)}`, 'success');
        
        // æ¸…ç†æ¸¬è©¦éµ
        setTimeout(() => localStorage.removeItem(testKey), 1000);
      }
    }
    
    // ==================== å¤šæ¨™ç±¤é æ¸¬è©¦ ====================
    
    function openNewWindow() {
      window.open(window.location.href, '_blank', 'width=1200,height=800');
    }
    
    // ==================== å®Œæ•´æ¸¬è©¦ ====================
    
    async function runFullTest() {
      const output = document.getElementById('full-test-output');
      output.innerHTML = '';
      
      log('full-test-output', 'ğŸ§ª é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶...', 'info');
      
      // æ¸¬è©¦ 1: æª¢æ¸¬æ”¯æ´
      log('full-test-output', '\n--- æ¸¬è©¦ 1: æª¢æ¸¬ BroadcastChannel æ”¯æ´ ---', 'info');
      testBroadcastChannelSupport();
      
      // æ¸¬è©¦ 2: åˆå§‹åŒ–
      log('full-test-output', '\n--- æ¸¬è©¦ 2: åˆå§‹åŒ– BroadcastChannel ---', 'info');
      initBroadcastChannel();
      
      // æ¸¬è©¦ 3: æ·»åŠ æ•¸æ“š
      log('full-test-output', '\n--- æ¸¬è©¦ 3: æ·»åŠ èª²ç¨‹è¨˜éŒ„ ---', 'info');
      for (let i = 0; i < 3; i++) {
        addTestRecord();
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // æ¸¬è©¦ 4: åˆ—å‡ºæ•¸æ“š
      log('full-test-output', '\n--- æ¸¬è©¦ 4: åˆ—å‡ºæ‰€æœ‰è¨˜éŒ„ ---', 'info');
      listAllRecords();
      
      // æ¸¬è©¦ 5: æª¢æŸ¥åŒæ­¥
      log('full-test-output', '\n--- æ¸¬è©¦ 5: æª¢æŸ¥åŒæ­¥ç‹€æ…‹ ---', 'info');
      checkSyncStatus();
      
      log('full-test-output', '\nâœ… å®Œæ•´æ¸¬è©¦å·²å®Œæˆ', 'success');
    }
    
    function generateReport() {
      const output = document.getElementById('full-test-output');
      output.innerHTML = '';
      
      const records = JSON.parse(localStorage.getItem(TEST_KEY) || '[]');
      
      const report = `
ğŸ“Š PLAN-A1 æ¸¬è©¦å ±å‘Š
==================
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}

âœ… BroadcastChannel æ”¯æ´: ${testResults.broadcastChannelSupported ? 'æ˜¯' : 'å¦'}
âœ… é€šé“åˆå§‹åŒ–: ${testResults.channelInitialized ? 'æ˜¯' : 'å¦'}
âœ… ç›£è½ç‹€æ…‹: ${isListening ? 'é–‹å•Ÿ' : 'é—œé–‰'}

ğŸ“ˆ çµ±è¨ˆæ•¸æ“š:
- èª²ç¨‹è¨˜éŒ„ç¸½æ•¸: ${records.length}
- æ¥æ”¶æ¶ˆæ¯æ•¸: ${testResults.messagesReceived}
- å·²åŒæ­¥è¨˜éŒ„: ${testResults.recordsSynced}

ğŸ“‹ åŠŸèƒ½é©—è­‰:
[${testResults.broadcastChannelSupported ? 'âœ…' : 'âŒ'}] BroadcastChannel API
[${testResults.channelInitialized ? 'âœ…' : 'âŒ'}] é€šé“åˆå§‹åŒ–
[${isListening ? 'âœ…' : 'âŒ'}] æ¶ˆæ¯ç›£è½
[${records.length > 0 ? 'âœ…' : 'âŒ'}] æ•¸æ“šå„²å­˜
[${testResults.messagesReceived > 0 ? 'âœ…' : 'âŒ'}] æ¶ˆæ¯å»£æ’­

ğŸ¯ çµè«–: ${testResults.broadcastChannelSupported && testResults.channelInitialized ? 'âœ… PLAN-A1 åŠŸèƒ½æ­£å¸¸' : 'âš ï¸ éœ€è¦é€²ä¸€æ­¥æª¢æŸ¥'}
      `;
      
      log('full-test-output', report, 'info');
    }
    
    function resetTest() {
      testResults = {
        broadcastChannelSupported: false,
        channelInitialized: false,
        messagesReceived: 0,
        recordsSynced: 0,
        tests: []
      };
      
      if (channel) {
        channel.close?.();
        channel = null;
      }
      
      isListening = false;
      
      document.querySelectorAll('.output').forEach(el => el.innerHTML = '');
      
      updateStat('stat-channel', 'âŒ');
      updateStat('stat-records', '0');
      updateStat('stat-synced', '0');
      updateStat('stat-status', 'å¾…æ¸¬');
      
      log('full-test-output', 'âœ… æ¸¬è©¦å·²é‡ç½®', 'success');
    }
    
    // ==================== åˆå§‹åŒ–é é¢ ====================
    
    window.addEventListener('load', () => {
      log('detect-output', 'é é¢å·²åŠ è¼‰ï¼Œæº–å‚™é€²è¡Œ PLAN-A1 æ¸¬è©¦', 'info');
      updateStat('stat-status', 'æº–å‚™ä¸­');
    });
  </script>
</body>
</html>

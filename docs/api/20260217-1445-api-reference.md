# API 參考文檔

**RS-System v3.0.0** | HKJRA 教練記錄系統 · 跳繩課堂 Checkpoint

---

## Phase 1: 工具層

### dom-utils

DOM 操作工具函數。

#### `$(id)` - 根據 ID 獲取元素
- **參數:** `id` (string)
- **返回:** `HTMLElement|null`
```javascript
const button = $('btnSave');
```

#### `$q(selector)` - 查詢單個元素
- **參數:** `selector` (string)
- **返回:** `Element|null`

#### `$qa(selector)` - 查詢所有元素
- **參數:** `selector` (string)
- **返回:** `NodeList`

---

### helpers

通用輔助函數。

#### `escapeHtml(text)` - HTML 轉義防 XSS
- **參數:** `text` (string)
- **返回:** `string`
```javascript
const safe = escapeHtml('<script>alert("xss")</script>');
```

#### `toast(message, type)` - 顯示提示訊息
- **參數:** `message` (string), `type` ('info'|'success'|'error')
```javascript
toast('操作成功', 'success');
```

#### `todayStr()` - 獲取今天日期
- **返回:** `string` (YYYY-MM-DD)

---

### formatters

數據格式化工具。

#### `formatFileSize(bytes)` - 格式化文件大小
- **參數:** `bytes` (number)
- **返回:** `string` (B, KB, MB, GB)
```javascript
formatFileSize(1024); // "1.00 KB"
```

#### `timeToMinutes(timeStr)` - 時間轉分鐘
- **參數:** `timeStr` (string, HH:MM)
- **返回:** `number`
```javascript
timeToMinutes('09:30'); // 570
```

#### `minutesToTime(minutes)` - 分鐘轉時間
- **參數:** `minutes` (number)
- **返回:** `string` (HH:MM)
```javascript
minutesToTime(570); // "09:30"
```

---

### validators

數據驗證工具。

#### `isRequired(value)` - 驗證必填
- **參數:** `value` (any)
- **返回:** `boolean`

#### `isValidDate(dateStr)` - 驗證日期 (YYYY-MM-DD)
- **參數:** `dateStr` (string)
- **返回:** `boolean`

#### `isValidTime(timeStr)` - 驗證時間 (HH:MM)
- **參數:** `timeStr` (string)
- **返回:** `boolean`

#### `isInRange(value, min, max)` - 驗證範圍
- **參數:** `value` (number), `min` (number), `max` (number)
- **返回:** `boolean`

---

### app-constants

應用常量。

#### `STORAGE_KEY` = `'rope-skip-checkpoints'`
儲存鍵名常量。

#### `RANGE_IDS` = `['engagement', 'mastery', ...]`
範圍評分項目 ID 列表（共 13 項）。

---

## Phase 2: 核心服務層

### storage-manager

儲存管理器 (STORAGE_MANAGER) - LocalStorage 統一管理，支援緩存、備份、跨標籤頁同步。

#### 主要方法

**`init()`** - 初始化儲存管理器
- **返回:** `Promise<boolean>`

**`getCheckpoints(userId?)`** - 獲取課堂記錄
- **參數:** `userId` (string|null, 可選)
- **返回:** `Promise<Array>`
```javascript
const records = await STORAGE_MANAGER.getCheckpoints();
const userRecords = await STORAGE_MANAGER.getCheckpoints('user_123');
```

**`saveCheckpoints(records)`** - 保存課堂記錄
- **參數:** `records` (Array)
- **返回:** `Promise<boolean>`

**`getPresets()`** - 獲取班級預設
- **返回:** `Promise<Array>`

**`savePresets(presets)`** - 保存班級預設
- **參數:** `presets` (Array)
- **返回:** `Promise<boolean>`

**`clearAll()`** - 清除所有數據（需確認）
- **返回:** `boolean`

**`getStats()`** - 獲取儲存統計
- **返回:** `{totalSize, details, usage}`

---

### login-manager

登入管理器 (LOGIN_MANAGER) - 用戶認證與會話管理。

#### 主要方法

**`init()`** - 初始化登入管理器
- **返回:** `boolean`

**`login(username, password)`** - 用戶登入
- **參數:** `username` (string), `password` (string)
- **返回:** `Promise<{success, user?, error?}>`
```javascript
const result = await LOGIN_MANAGER.login('admin', 'pass');
if (result.success) {
  window.location.href = 'index.html';
}
```

**`logout()`** - 用戶登出
- **返回:** `boolean`

**`checkSession()`** - 檢查會話有效性
- **返回:** `boolean`

**`isLoggedIn()`** - 檢查是否已登入
- **返回:** `boolean`

**`getCurrentUser()`** - 獲取當前用戶
- **返回:** `Object|null`

---

### RecordsService

記錄服務 - 課堂記錄 CRUD 操作。

#### 主要方法

**`getAllRecords()`** - 獲取所有記錄
- **返回:** `Array`

**`getRecordById(id)`** - 根據 ID 獲取記錄
- **參數:** `id` (string)
- **返回:** `Object|null`

**`createRecord(data)`** - 創建新記錄
- **參數:** `data` (Object)
- **返回:** `{success, record?, error?}`
```javascript
const result = RecordsService.createRecord({
  className: '初級班',
  classDate: '2026-02-17',
  classSize: 15
});
```

**`updateRecord(id, data)`** - 更新記錄
- **參數:** `id` (string), `data` (Object)
- **返回:** `{success, record?, error?}`

**`deleteRecord(id)`** - 刪除記錄
- **參數:** `id` (string)
- **返回:** `{success, error?}`

---

### PresetsService

預設服務 - 班級預設管理。

#### 主要方法

**`getAllPresets()`** - 獲取所有預設
- **返回:** `Array<string>`

**`createPreset(className)`** - 創建預設
- **參數:** `className` (string)
- **返回:** `{success, preset?, error?}`

**`deletePreset(className)`** - 刪除預設
- **參數:** `className` (string)
- **返回:** `{success, error?}`

**`applyPreset(className)`** - 應用預設
- **參數:** `className` (string)
- **返回:** `string|null`

---

### UsersService

用戶服務 - 用戶數據管理。

#### 主要方法

**`getAllUsers()`** - 獲取所有用戶
- **返回:** `Array`

**`getUser(username)`** - 根據用戶名獲取用戶
- **參數:** `username` (string)
- **返回:** `Object|null`

**`createUser(userData)`** - 創建新用戶
- **參數:** `{username, password, email?, role?}`
- **返回:** `{success, user?, error?}`
```javascript
const result = UsersService.createUser({
  username: 'coach_wang',
  password: 'secure123',
  email: 'wang@example.com'
});
```

**`updateUser(username, userData)`** - 更新用戶
- **參數:** `username` (string), `userData` (Object)
- **返回:** `{success, user?, error?}`

**`deleteUser(username)`** - 刪除用戶（不能刪除 creator）
- **參數:** `username` (string)
- **返回:** `{success, error?}`

---

## Phase 3: UI 管理層

### ui-manager

UI 管理器 (UI_MANAGER) - 統一管理介面顯示、狀態、載入指示器、響應式佈局、鍵盤快捷鍵。

#### 主要方法

**`init()`** - 初始化 UI 管理器
- **返回:** `boolean`

**`showView(viewId)`** - 顯示視圖
- **參數:** `viewId` (string)
```javascript
UI_MANAGER.showView('page-overview');
```

**`hideView(viewId)`** - 隱藏視圖
- **參數:** `viewId` (string)

**`toggleView(viewId)`** - 切換視圖
- **參數:** `viewId` (string)

---

### FormManager

表單管理器 - 處理表單數據讀取、寫入、驗證和重置。

#### 主要方法

**`getFormData(formElement?)`** - 獲取表單數據
- **參數:** `formElement` (HTMLFormElement|string, 可選)
- **返回:** `Object`
```javascript
const data = FormManager.getFormData();
// { className, classDate, classSize, engagement, ... }
```

**`setFormData(data)`** - 設置表單數據
- **參數:** `data` (Object)
```javascript
FormManager.setFormData({
  className: '初級班',
  classDate: '2026-02-17',
  engagement: 4
});
```

**`validateForm()`** - 驗證表單
- **返回:** `{valid, errors[]}`

---

### ListRenderer

列表渲染器 - 課堂記錄列表顯示、排序、過濾。

#### 主要方法

**`renderRecordsList(records, container, options)`** - 渲染列表
- **參數:** 
  - `records` (Array)
  - `container` (HTMLElement|string)
  - `options` (Object): `{limit, emptyMessage, onItemClick}`
```javascript
ListRenderer.renderRecordsList(records, 'recordsList', {
  limit: 10,
  onItemClick: (record) => console.log(record)
});
```

**`renderRecordItem(record, options)`** - 渲染單個項目
- **返回:** `string` (HTML)

**`renderEmptyState(container, message)`** - 渲染空狀態

---

### ModalManager

模態窗口管理器 - 彈窗與對話框處理。

#### 主要方法

**`openModal(modalId)`** - 打開模態窗口
- **參數:** `modalId` (string)
```javascript
ModalManager.openModal('detailModal');
```

**`closeModal(modalId)`** - 關閉模態窗口
- **參數:** `modalId` (string)

**`closeAllModals()`** - 關閉所有模態窗口

---

### TricksManager

花式技巧管理器 - 跳繩技巧數據的添加、編輯、刪除、渲染。

主要處理課堂中的技巧動作記錄。詳細方法請參考源碼。

---

### AttachmentsManager

附件管理器 - 檔案上傳、預覽、刪除、大小驗證。

主要處理課堂記錄的附件檔案。詳細方法請參考源碼。

---

### EventHandlers

事件處理器 - 應用程式事件統一管理（按鈕點擊、表單提交、頁面切換等）。

詳細方法請參考源碼。

---

## Phase 4: 初始化層

### AppInit

應用程式初始化 - 主應用啟動邏輯。

#### `AppInit.init(options)`

主初始化函式 - 協調所有初始化步驟。

**參數:**
- `options` (Object)
  - `env` (string): 環境名稱 ('development'|'production'|'test')
  - `skipAuth` (boolean): 跳過認證檢查
  - `skipUI` (boolean): 跳過 UI 初始化
  - `onProgress` (Function): 進度回調 `(step, progress) => {}`

**返回:** `Promise<boolean>`

**範例:**
```javascript
// 基本初始化
await AppInit.init();

// 開發環境
await AppInit.init({ env: 'development' });

// 帶進度回調
await AppInit.init({
  onProgress: (step, progress) => {
    console.log(`${step}: ${progress}%`);
  }
});
```

---

### LoginPageInit

登入頁面初始化 - 登入/註冊表單處理。

#### `LoginPageInit.init()`

初始化登入頁面。

**返回:** `boolean`

**範例:**
```javascript
// 在 login.html 中使用
LoginPageInit.init();
```

---

### config

配置管理 - 應用程式配置。

#### 主要導出

**`APP_CONFIG`** - 應用配置對象  
**`getConfig()`** - 獲取當前配置  
**`getConfigFromEnv(env)`** - 根據環境獲取配置  
**`validateConfig(config)`** - 驗證配置  
**`printConfig()`** - 打印配置（除敏感信息）

---

## 快速啟動 API

### `initApp(options)`

快速初始化應用程式（最簡單方式）。

**參數:** `options` - 同 AppInit.init  
**返回:** `Promise<boolean>`

```javascript
import { initApp } from './src/main.js';

await initApp();
await initApp({ env: 'development' });
```

---

### `initLoginPage()`

初始化登入頁面。

**返回:** `Promise<boolean>`

```javascript
import { initLoginPage } from './src/main.js';

await initLoginPage();
```

---

### `getAppInfo()`

獲取應用程式資訊。

**返回:** `{version, buildDate, name, fullName, modules}`

```javascript
const info = getAppInfo();
console.log(info.version); // "3.0.0"
```

---

### `isModuleAvailable(moduleName)`

檢查模組是否可用。

**參數:** `moduleName` (string)  
**返回:** `boolean`

---

## 版本資訊

**`VERSION`** = `'3.0.0'` - 版本號  
**`BUILD_DATE`** - 建置日期（ISO 8601）  
**`VERSION_INFO`** - 版本資訊對象 `{version, buildDate, name, fullName}`

---

## 使用範例

### 完整應用初始化
```javascript
import { initApp } from './src/main.js';

document.addEventListener('DOMContentLoaded', async () => {
  const success = await initApp({
    env: 'production',
    onProgress: (step, progress) => {
      console.log(`${step}: ${progress}%`);
    }
  });
  
  if (!success) console.error('啟動失敗');
});
```

### 記錄管理
```javascript
import { RecordsService, toast } from './src/main.js';

// 創建記錄
const result = RecordsService.createRecord({
  className: '初級班',
  classDate: '2026-02-17',
  classSize: 15
});

if (result.success) {
  toast('創建成功', 'success');
}

// 獲取所有記錄
const records = RecordsService.getAllRecords();
console.log(`共 ${records.length} 筆`);
```

### 用戶認證
```javascript
import { LOGIN_MANAGER, toast } from './src/main.js';

async function login(username, password) {
  const result = await LOGIN_MANAGER.login(username, password);
  
  if (result.success) {
    toast(`歡迎，${result.user.username}!`, 'success');
    window.location.href = 'index.html';
  } else {
    toast('登入失敗: ' + result.error, 'error');
  }
}
```

---

## 注意事項

### 編碼與儲存
- 數據使用 `encodeURIComponent + btoa` 編碼，支援中文
- 緩存有效期 5 分鐘，自動備份保留最近 3 個

### 權限控制
- **creator** 角色: 可查看所有記錄
- **普通用戶**: 僅能查看自己的記錄

### 安全性
- 使用 `escapeHtml` 防 XSS
- 密碼雜湊儲存，不存明文
- 會話有效期 24 小時
- 登入失敗 5 次鎖定 15 分鐘

### 跨標籤頁同步
- 支援 BroadcastChannel（需瀏覽器支援）
- 自動同步數據更新

---

**文檔版本:** 1.0 | **更新日期:** 2026-02-17 | **總行數:** 約 790 行

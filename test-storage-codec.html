<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StorageCodec æ¸¬è©¦</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 0.5rem;
    }
    .test-section {
      background: white;
      padding: 1.5rem;
      margin: 1rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: #007bff;
      margin-top: 0;
    }
    .status {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      margin: 0.5rem 0;
      font-family: monospace;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.25rem;
    }
    button:hover {
      background: #0056b3;
    }
    #output {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      min-height: 200px;
      max-height: 600px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª StorageCodec èˆ‡æ¸¬è©¦æ¡†æ¶é©—è­‰</h1>
  
  <div class="test-section">
    <h2>ğŸ“¦ æ¸¬è©¦èªªæ˜</h2>
    <p>æ­¤é é¢ç”¨æ–¼é©—è­‰ï¼š</p>
    <ul>
      <li><code>src/utils/storage-codec.js</code> - çµ±ä¸€çš„ç·¨ç¢¼/è§£ç¢¼å·¥å…·</li>
      <li><code>tests/manual/test-framework.js</code> - æ¸¬è©¦æ¡†æ¶å·¥å…·</li>
      <li><code>src/core/storage-manager.js</code> - æ›´æ–°å¾Œçš„å„²å­˜ç®¡ç†å™¨</li>
      <li><code>src/services/records-service.js</code> - æ›´æ–°å¾Œçš„è¨˜éŒ„æœå‹™</li>
    </ul>
  </div>

  <div class="test-section">
    <h2>ğŸ§ª åŸ·è¡Œæ¸¬è©¦</h2>
    <button onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
    <button onclick="clearOutput()">æ¸…é™¤è¼¸å‡º</button>
    <button onclick="localStorage.clear()">æ¸…é™¤ LocalStorage</button>
  </div>

  <div class="test-section">
    <h2>ğŸ“Š æ¸¬è©¦è¼¸å‡º</h2>
    <div id="output"></div>
  </div>

  <script type="module">
    import { StorageCodec } from './src/utils/storage-codec.js';
    import { TestFramework } from './tests/manual/test-framework.js';
    import { STORAGE_MANAGER } from './src/core/storage-manager.js';
    import { RecordsService } from './src/services/records-service.js';

    // å°‡æ¨¡çµ„æš´éœ²åˆ°å…¨åŸŸä»¥ä¾¿æŒ‰éˆ•ä½¿ç”¨
    window.StorageCodec = StorageCodec;
    window.TestFramework = TestFramework;
    window.STORAGE_MANAGER = STORAGE_MANAGER;
    window.RecordsService = RecordsService;

    const output = document.getElementById('output');
    
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = message;
      output.appendChild(div);
      console.log(message);
    }

    window.clearOutput = function() {
      output.innerHTML = '';
    };

    window.runAllTests = async function() {
      clearOutput();
      
      const tests = [
        {
          name: 'StorageCodec.encode() åŸºæœ¬ç·¨ç¢¼',
          fn: () => {
            const data = { name: 'æ¸¬è©¦', value: 123 };
            const encoded = StorageCodec.encode(data);
            if (!encoded) throw new Error('ç·¨ç¢¼å¤±æ•—');
            if (typeof encoded !== 'string') throw new Error('ç·¨ç¢¼çµæœæ‡‰ç‚ºå­—ä¸²');
            log(`âœ“ ç·¨ç¢¼æˆåŠŸ: ${encoded.substring(0, 50)}...`);
          }
        },
        {
          name: 'StorageCodec.decode() åŸºæœ¬è§£ç¢¼',
          fn: () => {
            const data = { name: 'æ¸¬è©¦', value: 123 };
            const encoded = StorageCodec.encode(data);
            const decoded = StorageCodec.decode(encoded);
            if (!decoded) throw new Error('è§£ç¢¼å¤±æ•—');
            if (decoded.name !== data.name) throw new Error('è§£ç¢¼è³‡æ–™ä¸åŒ¹é…');
            log(`âœ“ è§£ç¢¼æˆåŠŸ: ${JSON.stringify(decoded)}`);
          }
        },
        {
          name: 'StorageCodec æ”¯æ´ä¸­æ–‡',
          fn: () => {
            const data = { 
              èª²ç¨‹åç¨±: 'è·³ç¹©èª²ç¨‹',
              å…§å®¹: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦ï¼šåŒ…å«ä¸­æ–‡ã€æ•¸å­—123ã€ç¬¦è™Ÿï¼@#'
            };
            const encoded = StorageCodec.encode(data);
            const decoded = StorageCodec.decode(encoded);
            if (decoded.èª²ç¨‹åç¨± !== data.èª²ç¨‹åç¨±) throw new Error('ä¸­æ–‡è§£ç¢¼å¤±æ•—');
            log(`âœ“ ä¸­æ–‡æ”¯æ´æ­£å¸¸: ${decoded.èª²ç¨‹åç¨±}`);
          }
        },
        {
          name: 'StorageCodec.saveToStorage() èˆ‡ loadFromStorage()',
          fn: () => {
            const testKey = 'test-storage-codec';
            const testData = { id: 1, name: 'æ¸¬è©¦è¨˜éŒ„' };
            
            // å„²å­˜
            const saved = StorageCodec.saveToStorage(testKey, testData);
            if (!saved) throw new Error('å„²å­˜å¤±æ•—');
            
            // è¼‰å…¥
            const loaded = StorageCodec.loadFromStorage(testKey);
            if (!loaded || loaded.name !== testData.name) throw new Error('è¼‰å…¥å¤±æ•—');
            
            // æ¸…ç†
            localStorage.removeItem(testKey);
            log(`âœ“ å„²å­˜å’Œè¼‰å…¥åŠŸèƒ½æ­£å¸¸`);
          }
        },
        {
          name: 'StorageCodec è™•ç†ç©ºå€¼',
          fn: () => {
            const result1 = StorageCodec.decode(null);
            const result2 = StorageCodec.decode('');
            const result3 = StorageCodec.loadFromStorage('non-existent-key', 'default');
            
            if (result1 !== null) throw new Error('null è™•ç†å¤±æ•—');
            if (result2 !== null) throw new Error('ç©ºå­—ä¸²è™•ç†å¤±æ•—');
            if (result3 !== 'default') throw new Error('é è¨­å€¼è™•ç†å¤±æ•—');
            
            log(`âœ“ ç©ºå€¼è™•ç†æ­£å¸¸`);
          }
        },
        {
          name: 'StorageCodec å‘å¾Œå…¼å®¹ï¼ˆèˆŠç‰ˆ btoaï¼‰',
          fn: () => {
            // æ¨¡æ“¬èˆŠç‰ˆç·¨ç¢¼ï¼ˆåƒ… btoaï¼‰
            const data = { test: 'legacy' };
            const oldEncoded = btoa(JSON.stringify(data));
            const decoded = StorageCodec.decode(oldEncoded);
            
            if (!decoded || decoded.test !== 'legacy') throw new Error('å‘å¾Œå…¼å®¹å¤±æ•—');
            log(`âœ“ å‘å¾Œå…¼å®¹æ­£å¸¸ï¼ˆbtoa æ ¼å¼ï¼‰`);
          }
        },
        {
          name: 'StorageCodec å‘å¾Œå…¼å®¹ï¼ˆç´” JSONï¼‰',
          fn: () => {
            // æ¨¡æ“¬æœ€èˆŠç‰ˆç·¨ç¢¼ï¼ˆç´” JSONï¼‰
            const data = { test: 'plain' };
            const plainJson = JSON.stringify(data);
            const decoded = StorageCodec.decode(plainJson);
            
            if (!decoded || decoded.test !== 'plain') throw new Error('å‘å¾Œå…¼å®¹å¤±æ•—');
            log(`âœ“ å‘å¾Œå…¼å®¹æ­£å¸¸ï¼ˆç´” JSON æ ¼å¼ï¼‰`);
          }
        },
        {
          name: 'STORAGE_MANAGER ä½¿ç”¨ StorageCodec',
          fn: async () => {
            // æ¸¬è©¦ STORAGE_MANAGER æ˜¯å¦æ­£ç¢ºä½¿ç”¨ StorageCodec
            const testRecords = [
              { id: 1, className: 'æ¸¬è©¦ç­ç´š', classDate: '2024-01-01' }
            ];
            
            const saved = await STORAGE_MANAGER.saveCheckpoints(testRecords);
            if (!saved) throw new Error('å„²å­˜å¤±æ•—');
            
            const loaded = await STORAGE_MANAGER.getCheckpoints();
            if (!loaded || loaded.length === 0) throw new Error('è¼‰å…¥å¤±æ•—');
            if (loaded[0].className !== testRecords[0].className) throw new Error('è³‡æ–™ä¸åŒ¹é…');
            
            log(`âœ“ STORAGE_MANAGER æ•´åˆæ­£å¸¸`);
          }
        },
        {
          name: 'RecordsService ä½¿ç”¨ StorageCodec',
          fn: () => {
            // æ¸¬è©¦ RecordsService æ˜¯å¦æ­£ç¢ºä½¿ç”¨ StorageCodec
            const testRecords = [
              { id: 'rec1', className: 'æ¸¬è©¦ç­ç´š', classDate: '2024-01-01' }
            ];
            
            RecordsService.saveRecords(testRecords);
            const loaded = RecordsService.getAllRecords();
            
            if (!loaded || loaded.length === 0) throw new Error('è¼‰å…¥å¤±æ•—');
            if (loaded[0].className !== testRecords[0].className) throw new Error('è³‡æ–™ä¸åŒ¹é…');
            
            log(`âœ“ RecordsService æ•´åˆæ­£å¸¸`);
          }
        },
        {
          name: 'TestFramework åŸºæœ¬åŠŸèƒ½',
          fn: async () => {
            const tf = Object.create(TestFramework);
            tf.results = [];
            
            await tf.runTest('æ¸¬è©¦1', () => {});
            await tf.runTest('æ¸¬è©¦2', () => { throw new Error('é æœŸå¤±æ•—'); });
            
            if (tf.results.length !== 2) throw new Error('çµæœè¨˜éŒ„éŒ¯èª¤');
            if (tf.results[0].status !== 'pass') throw new Error('æˆåŠŸæ¸¬è©¦è¨˜éŒ„éŒ¯èª¤');
            if (tf.results[1].status !== 'fail') throw new Error('å¤±æ•—æ¸¬è©¦è¨˜éŒ„éŒ¯èª¤');
            
            log(`âœ“ TestFramework åŠŸèƒ½æ­£å¸¸`);
          }
        }
      ];

      const summary = await TestFramework.runTests(tests);
      
      log('\n' + '='.repeat(60), 'info');
      log(`ğŸ“Š ç¸½çµ: ${summary.passed} é€šé / ${summary.failed} å¤±æ•— / å…± ${summary.total} é …`, 
          summary.failed === 0 ? 'success' : 'error');
      log('='.repeat(60), 'info');
    };

    // è‡ªå‹•åŸ·è¡Œæ¸¬è©¦
    console.log('âœ… æ¨¡çµ„è¼‰å…¥æˆåŠŸï¼Œæº–å‚™åŸ·è¡Œæ¸¬è©¦...');
    log('âœ… æ‰€æœ‰æ¨¡çµ„å·²è¼‰å…¥ï¼Œé»æ“Šã€ŒåŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ã€é–‹å§‹æ¸¬è©¦', 'success');
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç³»çµ±å„²å­˜èˆ‡åˆ·æ–°æ¸¬è©¦</title>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    .test-step {
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      border-radius: 4px;
    }
    .test-step.pass {
      border-left-color: #059669;
      background: #f0fdf4;
    }
    .test-step.fail {
      border-left-color: #dc2626;
      background: #fef2f2;
    }
    .test-result {
      margin-top: 15px;
      padding: 15px;
      background: #f0f9ff;
      border: 1px solid #0284c7;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px 10px 0;
      font-size: 14px;
    }
    button:hover {
      background: #764ba2;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª æ•™ç·´è¨˜éŒ„ç³»çµ± - å„²å­˜èˆ‡åˆ·æ–°æ¸¬è©¦</h1>
  
  <div class="test-container">
    <div class="test-title">æ¸¬è©¦æ­¥é©Ÿ</div>
    <button onclick="testFullFlow()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹</button>
    <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
    <div id="results" class="test-result" style="display:none;"></div>
  </div>

  <div class="test-container">
    <div class="test-title">æ¸¬è©¦èªªæ˜</div>
    <div class="test-step">
      æœ¬æ¸¬è©¦æœƒï¼š
      <ul>
        <li>1. é©—è­‰ç³»çµ±æ˜¯å¦å·²ç™»å…¥</li>
        <li>2. å»ºç«‹æ¸¬è©¦èª²å ‚ç´€éŒ„</li>
        <li>3. ç›´æ¥å‘¼å« refreshAllViews() ä¸¦æª¢æŸ¥ UI æ›´æ–°</li>
        <li>4. é©—è­‰å´é‚Šæ¬„çµ±è¨ˆã€å­¸ç”Ÿç®¡ç†ã€å‹•ä½œè¨˜éŒ„ã€çµ±è¨ˆåˆ†ææ˜¯å¦æœ‰æ›´æ–°</li>
        <li>5. åˆ—å‡ºæ‰€æœ‰æ‰¾åˆ°/æœªæ‰¾åˆ°çš„å…ƒç´ </li>
      </ul>
    </div>
  </div>

  <script>
    function log(msg, type = 'info') {
      const el = document.getElementById('results');
      if (!el) return;
      if (el.style.display === 'none') el.style.display = 'block';
      
      const timestamp = new Date().toLocaleTimeString('zh-TW');
      const prefix = type === 'pass' ? 'âœ…' : type === 'fail' ? 'âŒ' : 'â„¹ï¸';
      const line = `[${timestamp}] ${prefix} ${msg}\n`;
      
      el.textContent += line;
      el.scrollTop = el.scrollHeight;
    }

    function clearResults() {
      const el = document.getElementById('results');
      if (el) {
        el.textContent = '';
        el.style.display = 'none';
      }
    }

    async function testFullFlow() {
      clearResults();
      log('é–‹å§‹æ¸¬è©¦...');
      
      try {
        // æª¢æŸ¥ index.html æ˜¯å¦å·²åŠ è¼‰
        if (typeof window.getFormData === 'undefined') {
          log('âŒ ç³»çµ±æœªåŠ è¼‰ï¼Œè«‹å…ˆåœ¨ index.html ä¸­é–‹å•Ÿæ­¤é é¢', 'fail');
          log('å¦‚æœåœ¨æ–°è¦–çª—é–‹å•Ÿï¼Œè«‹å…ˆç™»å…¥ index.htmlï¼Œå†å›åˆ°æ­¤é é¢åŸ·è¡Œæ¸¬è©¦', 'info');
          return;
        }

        log('âœ… ç³»çµ±å·²åŠ è¼‰', 'pass');

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const currentUser = window.getCurrentUser?.();
        if (!currentUser) {
          log('âš ï¸  æœªç™»å…¥æˆ–ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼Œä½¿ç”¨ guest èº«ä»½', 'info');
        } else {
          log(`âœ… å·²ç™»å…¥ç‚ºï¼š${currentUser.username}`, 'pass');
        }

        // æº–å‚™æ¸¬è©¦è³‡æ–™
        const testRecord = {
          classDate: window.todayStr?.() || new Date().toISOString().split('T')[0],
          className: 'ã€è‡ªå‹•æ¸¬è©¦ã€‘ç­',
          classSize: 25,
          classLocation: '',
          teachingRole: '',
          classStartTime: '10:00',
          classEndTime: '11:00',
          classDurationMins: 60,
          notes: 'è‡ªå‹•åŒ–æ¸¬è©¦ç´€éŒ„',
          engagement: 4,
          atmosphere: 'é–‹å¿ƒ',
          tricks: [{ name: 'å–®è·³', detail: 'åŸºç¤æŠ€å·§', level: 'åˆç´š' }],
          mastery: 75,
          plannedTime: 30,
          actualTime: 35,
          skillLevel: 'åˆç´š',
          helpOthers: 60,
          interaction: 70,
          teamwork: 65,
          selfPractice: 70,
          activeLearn: 75,
          positivity: 4,
          enthusiasm: 4,
          teachScore: 8,
          satisfaction: 4,
          disciplineCount: 0,
          flexibility: 8,
          individual: 70
        };

        log(`ğŸ“ æº–å‚™å„²å­˜æ¸¬è©¦ç´€éŒ„ï¼š${testRecord.className}`);

        // å„²å­˜ç´€éŒ„
        if (typeof window.parseRecords !== 'undefined' && typeof window.saveRecords !== 'undefined') {
          const list = window.parseRecords();
          const idx = list.findIndex(r => r.classDate === testRecord.classDate && r.className === testRecord.className);
          if (idx >= 0) list[idx] = testRecord;
          else list.push(testRecord);
          list.sort((a, b) => (b.classDate || '').localeCompare(a.classDate || ''));
          window.saveRecords(list);
          log(`âœ… ç´€éŒ„å·²å„²å­˜ (ç¸½è¨ˆ ${list.length} ç­†)`, 'pass');
        } else {
          log('âŒ ç„¡æ³•å­˜å–å„²å­˜å‡½æ•¸', 'fail');
          return;
        }

        // è§¸ç™¼åˆ·æ–°
        log('ğŸ”„ è§¸ç™¼ refreshAllViews()...');
        if (typeof window.refreshAllViews !== 'undefined') {
          window.refreshAllViews();
          log('âœ… refreshAllViews() å·²åŸ·è¡Œ', 'pass');
        } else {
          log('âŒ refreshAllViews() ä¸å­˜åœ¨', 'fail');
          return;
        }

        // ç­‰å¾… DOM æ›´æ–°
        await new Promise(resolve => setTimeout(resolve, 500));

        // é©—è­‰ UI æ›´æ–°
        log('\nğŸ“Š é©—è­‰ UI å…ƒç´ æ›´æ–°ï¼š');

        const checks = [
          { id: 'todayCount', desc: 'ä»Šæ—¥èª²å ‚æ•¸' },
          { id: 'totalStudents', desc: 'å­¸ç”Ÿç¸½æ•¸' },
          { id: 'recentList', desc: 'æœ€è¿‘èª²ç¨‹åˆ—è¡¨' },
          { id: 'byClassList', desc: 'ç­åˆ¥çµ±è¨ˆåˆ—è¡¨' },
          { id: 'actionsTableBody', desc: 'å‹•ä½œè¨˜éŒ„è¡¨æ ¼' },
          { id: 'analyticsChart', desc: 'çµ±è¨ˆåˆ†æåœ–è¡¨' }
        ];

        let updateCount = 0;
        checks.forEach(check => {
          const el = document.getElementById(check.id);
          if (el) {
            const hasContent = el.textContent?.trim().length > 0 || el.innerHTML?.trim().length > 0;
            if (hasContent || el.children?.length > 0) {
              log(`âœ… ${check.desc} å·²æ›´æ–°`, 'pass');
              updateCount++;
            } else {
              log(`âš ï¸  ${check.desc} æ‰¾åˆ°ä½†å…§å®¹ç‚ºç©º`, 'info');
            }
          } else {
            log(`âŒ ${check.desc} å…ƒç´ ä¸å­˜åœ¨ (#${check.id})`, 'fail');
          }
        });

        log(`\nğŸ“ˆ æ›´æ–°æ‘˜è¦ï¼š${updateCount}/${checks.length} å€‹å…ƒç´ æœ‰å…§å®¹`);

        // è®€å–æœ€çµ‚è³‡æ–™ç‹€æ…‹
        const finalRecords = window.parseRecords?.();
        const testRecordInStorage = finalRecords?.find(r => r.className === testRecord.className);
        
        if (testRecordInStorage) {
          log(`\nâœ… æ¸¬è©¦ç´€éŒ„å·²ç¢ºèªä¿å­˜åœ¨ç³»çµ±ä¸­`, 'pass');
          log(`   - ç­ç´šï¼š${testRecordInStorage.className}`);
          log(`   - æ—¥æœŸï¼š${testRecordInStorage.classDate}`);
          log(`   - äººæ•¸ï¼š${testRecordInStorage.classSize}`);
        } else {
          log('\nâŒ æ¸¬è©¦ç´€éŒ„æœªæ‰¾åˆ°', 'fail');
        }

        log('\nâœ… æ¸¬è©¦å®Œæˆï¼');

      } catch (error) {
        log(`âŒ æ¸¬è©¦ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`, 'fail');
        console.error(error);
      }
    }
  </script>
</body>
</html>

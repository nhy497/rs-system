<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»çµ±é©—è­‰æ¸¬è©¦ - RS System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Microsoft JhengHei", Arial, sans-serif; padding: 2rem; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; margin-bottom: 1rem; }
    h2 { color: #34495e; margin-top: 2rem; margin-bottom: 1rem; font-size: 1.3rem; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; }
    .test-section { margin: 1.5rem 0; padding: 1rem; background: #f9f9f9; border-left: 4px solid #3498db; }
    .test-result { margin: 0.5rem 0; padding: 0.5rem; border-radius: 4px; font-family: "Consolas", monospace; }
    .test-result.pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .test-result.fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .test-result.warn { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .test-result.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    button { padding: 0.6rem 1.2rem; margin: 0.5rem 0.5rem 0.5rem 0; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95rem; }
    button:hover { background: #2980b9; }
    button.danger { background: #e74c3c; }
    button.danger:hover { background: #c0392b; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-card h3 { font-size: 2rem; margin: 0.5rem 0; }
    .stat-card p { opacity: 0.9; }
    pre { background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.9rem; }
    .progress { margin: 1rem 0; }
    .progress-bar { height: 30px; background: #ecf0f1; border-radius: 15px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ç³»çµ±é©—è­‰æ¸¬è©¦ä¸­å¿ƒ</h1>
    <p style="color: #7f8c8d; margin-bottom: 2rem;">å…¨é¢é©—è­‰åŠŸèƒ½é‹è¡Œã€æ•¸æ“šé€£æ¥ã€ä¸»éµé—œè¯èˆ‡å­˜å„²æ•ˆç‡</p>

    <div class="stats">
      <div class="stat-card">
        <p>æ¸¬è©¦ç¸½æ•¸</p>
        <h3 id="totalTests">0</h3>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
        <p>é€šéæ¸¬è©¦</p>
        <h3 id="passedTests">0</h3>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
        <p>å¤±æ•—æ¸¬è©¦</p>
        <h3 id="failedTests">0</h3>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <p>è­¦å‘Šé …ç›®</p>
        <h3 id="warningTests">0</h3>
      </div>
    </div>

    <div class="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%;">0%</div>
      </div>
    </div>

    <div style="margin: 2rem 0;">
      <button onclick="runAllTests()">ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
      <button onclick="runAuthTests()">ğŸ” æ¸¬è©¦èªè­‰ç³»çµ±</button>
      <button onclick="runDataTests()">ğŸ“Š æ¸¬è©¦è³‡æ–™ç®¡ç†</button>
      <button onclick="runStorageTests()">ğŸ’¾ æ¸¬è©¦å­˜å„²ç³»çµ±</button>
      <button onclick="runIntegrationTests()">ğŸ”— æ¸¬è©¦æ•´åˆæµç¨‹</button>
      <button class="danger" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
    </div>

    <h2>ğŸ“‹ æ¸¬è©¦çµæœ</h2>
    <div id="testResults"></div>

    <h2>ğŸ“ˆ ä»£ç¢¼è¤‡é›œåº¦åˆ†æ</h2>
    <div id="complexityAnalysis"></div>

    <h2>ğŸ’½ å­˜å„²ä½¿ç”¨åˆ†æ</h2>
    <div id="storageAnalysis"></div>

    <h2>ğŸ”‘ ä¸»éµèˆ‡å¤–éµé©—è­‰</h2>
    <div id="keyAnalysis"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
  <script src="logger-service.js"></script>
  <script src="system.js"></script>
  <script>
    let testResults = { total: 0, passed: 0, failed: 0, warnings: 0 };
    let testLogs = [];

    // è¼•é‡èªè­‰ç®¡ç†å™¨ï¼ˆå…§åµŒç‰ˆæœ¬ï¼Œå–ä»£ user-auth.jsï¼‰
    const AUTH_KEYS = { USERS: 'rs-system-users', SESSION: 'rs-system-session' };

    const authManager = {
      _hashPassword(password) {
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
          const char = password.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return Math.abs(hash).toString(16);
      },
      _loadUsers() {
        try { return JSON.parse(localStorage.getItem(AUTH_KEYS.USERS) || '{}'); } catch { return {}; }
      },
      _saveUsers(users) {
        localStorage.setItem(AUTH_KEYS.USERS, JSON.stringify(users));
      },
      _createSession(user) {
        const session = {
          userId: user.userId,
          username: user.username,
          sessionId: `session_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,
          createdAt: Date.now(),
          expiresAt: Date.now() + 24 * 60 * 60 * 1000
        };
        localStorage.setItem(AUTH_KEYS.SESSION, JSON.stringify(session));
        localStorage.setItem('current-user', JSON.stringify({
          id: user.userId,
          userId: user.userId,
          username: user.username,
          email: user.email || '',
          role: user.role || 'user'
        }));
        return session;
      },
      getCurrentUser() {
        try {
          const session = JSON.parse(localStorage.getItem(AUTH_KEYS.SESSION) || 'null');
          if (!session || Date.now() > session.expiresAt) return null;
          const users = this._loadUsers();
          return Object.values(users).find(u => u.userId === session.userId) || null;
        } catch { return null; }
      },
      async register(username, password, email = '', role = 'user') {
        const users = this._loadUsers();
        if (Object.values(users).some(u => u.username === username)) {
          return { success: false, error: 'ä½¿ç”¨è€…åç¨±å·²å­˜åœ¨' };
        }
        const userId = `user_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
        users[userId] = {
          userId,
          username,
          email,
          role,
          passwordHash: this._hashPassword(password),
          createdAt: new Date().toISOString(),
          lastLogin: null
        };
        this._saveUsers(users);
        return { success: true, userId };
      },
      async login(username, password) {
        const users = this._loadUsers();
        const user = Object.values(users).find(u => u.username === username);
        if (!user) return { success: false, error: 'ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤' };
        if (this._hashPassword(password) !== user.passwordHash) {
          return { success: false, error: 'ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤' };
        }
        user.lastLogin = new Date().toISOString();
        this._saveUsers(users);
        this._createSession(user);
        return { success: true, user: { userId: user.userId, username: user.username } };
      },
      async logout() {
        localStorage.removeItem(AUTH_KEYS.SESSION);
        localStorage.removeItem('current-user');
        return { success: true };
      },
      getAllUsers() {
        return Object.values(this._loadUsers());
      },
      getUserStats() {
        const users = this.getAllUsers();
        return { totalUsers: users.length, users };
      }
    };

    // ============ æ¸¬è©¦å·¥å…·å‡½æ•¸ ============
    function log(message, type = 'info') {
      const resultDiv = document.getElementById('testResults');
      const logEntry = document.createElement('div');
      logEntry.className = `test-result ${type}`;
      
      const icon = type === 'pass' ? 'âœ…' : type === 'fail' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : 'â„¹ï¸';
      logEntry.textContent = `${icon} ${message}`;
      
      resultDiv.appendChild(logEntry);
      testLogs.push({ message, type, timestamp: new Date().toISOString() });

      // æ›´æ–°çµ±è¨ˆ
      testResults.total++;
      if (type === 'pass') testResults.passed++;
      else if (type === 'fail') testResults.failed++;
      else if (type === 'warn') testResults.warnings++;

      updateStats();
    }

    function updateStats() {
      document.getElementById('totalTests').textContent = testResults.total;
      document.getElementById('passedTests').textContent = testResults.passed;
      document.getElementById('failedTests').textContent = testResults.failed;
      document.getElementById('warningTests').textContent = testResults.warnings;

      const progress = testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0;
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = progress + '%';
      progressBar.textContent = progress + '%';
    }

    function clearResults() {
      document.getElementById('testResults').innerHTML = '';
      testResults = { total: 0, passed: 0, failed: 0, warnings: 0 };
      testLogs = [];
      updateStats();
      log('æ¸¬è©¦çµæœå·²æ¸…é™¤', 'info');
    }

    // ============ èªè­‰ç³»çµ±æ¸¬è©¦ ============
    async function runAuthTests() {
      log('===== é–‹å§‹èªè­‰ç³»çµ±æ¸¬è©¦ =====', 'info');

      // æ¸¬è©¦ 1: ç”¨æˆ¶è¨»å†Š - userId ä¸»éµç”Ÿæˆ
      try {
        const testUsername = 'test_user_' + Date.now();
        const result = await authManager.register(testUsername, 'test1234', 'test@example.com', 'user');
        
        if (result.success && result.userId) {
          log(`æ¸¬è©¦ 1.1: ç”¨æˆ¶è¨»å†ŠæˆåŠŸï¼ŒuserId ç”Ÿæˆ: ${result.userId}`, 'pass');
          
          // é©—è­‰ userId æ ¼å¼
          if (result.userId.startsWith('user_') && result.userId.length > 15) {
            log('æ¸¬è©¦ 1.2: userId ä¸»éµæ ¼å¼æ­£ç¢º (user_timestamp_random)', 'pass');
          } else {
            log('æ¸¬è©¦ 1.2: userId æ ¼å¼ç•°å¸¸', 'fail');
          }
        } else {
          log('æ¸¬è©¦ 1.1: ç”¨æˆ¶è¨»å†Šå¤±æ•— - ' + result.error, 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 1.1: ç”¨æˆ¶è¨»å†Šç•°å¸¸ - ' + err.message, 'fail');
      }

      // æ¸¬è©¦ 2: ç”¨æˆ¶ç™»å…¥ - sessionId ç”Ÿæˆ
      try {
        const testUsername = 'test_user_' + (Date.now() - 1000);
        await authManager.register(testUsername, 'test1234', 'test2@example.com');
        const loginResult = await authManager.login(testUsername, 'test1234');
        
        if (loginResult.success) {
          log('æ¸¬è©¦ 2.1: ç”¨æˆ¶ç™»å…¥æˆåŠŸ', 'pass');
          
          const currentUser = authManager.getCurrentUser();
          if (currentUser && currentUser.userId) {
            log(`æ¸¬è©¦ 2.2: æœƒè©±å»ºç«‹æˆåŠŸï¼ŒuserId: ${currentUser.userId}`, 'pass');
          }
        } else {
          log('æ¸¬è©¦ 2.1: ç”¨æˆ¶ç™»å…¥å¤±æ•—', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 2: ç™»å…¥æ¸¬è©¦ç•°å¸¸ - ' + err.message, 'fail');
      }

      // æ¸¬è©¦ 3: æœƒè©±æŒä¹…æ€§
      try {
        const session = localStorage.getItem('rs-system-session');
        if (session) {
          const sessionData = JSON.parse(session);
          if (sessionData.userId && sessionData.sessionId) {
            log('æ¸¬è©¦ 3: æœƒè©±æŒä¹…æ€§é©—è­‰æˆåŠŸ (userId â†” sessionId é—œè¯)', 'pass');
          } else {
            log('æ¸¬è©¦ 3: æœƒè©±æ•¸æ“šä¸å®Œæ•´', 'fail');
          }
        } else {
          log('æ¸¬è©¦ 3: æœªæ‰¾åˆ°æœƒè©±æ•¸æ“š', 'warn');
        }
      } catch (err) {
        log('æ¸¬è©¦ 3: æœƒè©±é©—è­‰ç•°å¸¸', 'fail');
      }

      // æ¸¬è©¦ 4: å¯†ç¢¼é›œæ¹Šé©—è­‰
      try {
        const hash1 = authManager._hashPassword('test123');
        const hash2 = authManager._hashPassword('test123');
        const hash3 = authManager._hashPassword('different');
        
        if (hash1 === hash2 && hash1 !== hash3) {
          log('æ¸¬è©¦ 4: å¯†ç¢¼é›œæ¹Šå‡½æ•¸é‹è¡Œæ­£å¸¸', 'pass');
        } else {
          log('æ¸¬è©¦ 4: å¯†ç¢¼é›œæ¹Šçµæœç•°å¸¸', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 4: å¯†ç¢¼é›œæ¹Šæ¸¬è©¦ç•°å¸¸', 'fail');
      }

      // æ¸¬è©¦ 5: ç”¨æˆ¶å”¯ä¸€æ€§æª¢æŸ¥
      try {
        const duplicateUsername = 'duplicate_test_' + Date.now();
        await authManager.register(duplicateUsername, 'pass1', 'test@test.com');
        const duplicateResult = await authManager.register(duplicateUsername, 'pass2', 'test2@test.com');
        
        if (!duplicateResult.success && duplicateResult.error.includes('å·²å­˜åœ¨')) {
          log('æ¸¬è©¦ 5: ç”¨æˆ¶å”¯ä¸€æ€§ç´„æŸæ­£å¸¸ (username ä½œç‚ºè‡ªç„¶éµ)', 'pass');
        } else {
          log('æ¸¬è©¦ 5: ç”¨æˆ¶å”¯ä¸€æ€§ç´„æŸå¤±æ•—', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 5: å”¯ä¸€æ€§æ¸¬è©¦ç•°å¸¸', 'fail');
      }

      log('===== èªè­‰ç³»çµ±æ¸¬è©¦å®Œæˆ =====', 'info');
    }

    // ============ è³‡æ–™ç®¡ç†æ¸¬è©¦ ============
    async function runDataTests() {
      log('===== é–‹å§‹è³‡æ–™ç®¡ç†æ¸¬è©¦ =====', 'info');

      // ç¢ºä¿æœ‰æ¸¬è©¦æ•¸æ“šç’°å¢ƒ
      const testRecords = [];

      // æ¸¬è©¦ 6: èª²å ‚è¨˜éŒ„è¤‡åˆä¸»éµ
      try {
        const testRecord = {
          classDate: '2026-01-24',
          className: 'TestClass_' + Date.now(),
          classSize: 25,
          atmosphere: 'æ´»æ½‘',
          notes: 'æ¸¬è©¦è¨˜éŒ„'
        };

        // æ¨¡æ“¬ä¿å­˜
        testRecords.push(testRecord);
        
        // æª¢æŸ¥è¤‡åˆä¸»éµ
        const duplicateCheck = testRecords.filter(r => 
          r.classDate === testRecord.classDate && r.className === testRecord.className
        );

        if (duplicateCheck.length === 1) {
          log('æ¸¬è©¦ 6.1: èª²å ‚è¨˜éŒ„è¤‡åˆä¸»éµ (classDate + className) æ­£å¸¸', 'pass');
        } else {
          log('æ¸¬è©¦ 6.1: è¤‡åˆä¸»éµé‡è¤‡æª¢æ¸¬å¤±æ•—', 'fail');
        }

        // æ¸¬è©¦é‡è¤‡è¨˜éŒ„æª¢æ¸¬
        testRecords.push({...testRecord});
        const duplicateCheck2 = testRecords.filter(r => 
          r.classDate === testRecord.classDate && r.className === testRecord.className
        );
        
        if (duplicateCheck2.length > 1) {
          log('æ¸¬è©¦ 6.2: é‡è¤‡è¨˜éŒ„æª¢æ¸¬åŠŸèƒ½æ­£å¸¸', 'pass');
        }

      } catch (err) {
        log('æ¸¬è©¦ 6: è¤‡åˆä¸»éµæ¸¬è©¦ç•°å¸¸ - ' + err.message, 'fail');
      }

      // æ¸¬è©¦ 7: localStorage ç·¨ç¢¼/è§£ç¢¼
      try {
        const testData = [{ test: 'æ¸¬è©¦æ•¸æ“š', date: '2026-01-24' }];
        const encoded = btoa(JSON.stringify(testData));
        const decoded = JSON.parse(atob(encoded));

        if (JSON.stringify(decoded) === JSON.stringify(testData)) {
          log('æ¸¬è©¦ 7: Base64 ç·¨ç¢¼/è§£ç¢¼æ­£å¸¸é‹è¡Œ', 'pass');
        } else {
          log('æ¸¬è©¦ 7: ç·¨ç¢¼è§£ç¢¼çµæœä¸ä¸€è‡´', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 7: ç·¨ç¢¼æ¸¬è©¦ç•°å¸¸', 'fail');
      }

      // æ¸¬è©¦ 8: ç­ç´šé è¨­å”¯ä¸€æ€§
      try {
        const presets = ['ClassA', 'ClassB', 'ClassA', 'ClassC'];
        const uniquePresets = [...new Set(presets)];
        
        if (uniquePresets.length === 3 && !uniquePresets.includes('ClassA', 1)) {
          log('æ¸¬è©¦ 8: ç­ç´šé è¨­ className å”¯ä¸€æ€§ç´„æŸæ­£å¸¸', 'pass');
        } else {
          log('æ¸¬è©¦ 8: ç­ç´šé è¨­å»é‡æ©Ÿåˆ¶ç•°å¸¸', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 8: ç­ç´šé è¨­æ¸¬è©¦ç•°å¸¸', 'fail');
      }

      // æ¸¬è©¦ 9: æ—¥æœŸæ ¼å¼é©—è­‰
      try {
        const validDate = '2026-01-24';
        const invalidDate = '24/01/2026';
        
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (dateRegex.test(validDate) && !dateRegex.test(invalidDate)) {
          log('æ¸¬è©¦ 9: æ—¥æœŸæ ¼å¼é©—è­‰æ­£å¸¸ (YYYY-MM-DD)', 'pass');
        } else {
          log('æ¸¬è©¦ 9: æ—¥æœŸæ ¼å¼é©—è­‰å¤±æ•—', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 9: æ—¥æœŸé©—è­‰ç•°å¸¸', 'fail');
      }

      log('===== è³‡æ–™ç®¡ç†æ¸¬è©¦å®Œæˆ =====', 'info');
    }

    // ============ å­˜å„²ç³»çµ±æ¸¬è©¦ ============
    async function runStorageTests() {
      log('===== é–‹å§‹å­˜å„²ç³»çµ±æ¸¬è©¦ =====', 'info');

      // æ¸¬è©¦ 10: localStorage å¯ç”¨æ€§
      try {
        const testKey = 'storage-test-' + Date.now();
        localStorage.setItem(testKey, 'test');
        const retrieved = localStorage.getItem(testKey);
        localStorage.removeItem(testKey);

        if (retrieved === 'test') {
          log('æ¸¬è©¦ 10: localStorage è®€å¯«æ­£å¸¸', 'pass');
        } else {
          log('æ¸¬è©¦ 10: localStorage è®€å–å¤±æ•—', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 10: localStorage ä¸å¯ç”¨ - ' + err.message, 'fail');
      }

      // æ¸¬è©¦ 11: å­˜å„²ç©ºé–“ä½¿ç”¨
      try {
        let totalSize = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length + key.length;
          }
        }

        const sizeKB = (totalSize / 1024).toFixed(2);
        if (totalSize > 0) {
          log(`æ¸¬è©¦ 11: ç•¶å‰å­˜å„²ä½¿ç”¨é‡: ${sizeKB} KB`, 'info');
          
          if (sizeKB < 1000) {
            log('æ¸¬è©¦ 11.1: å­˜å„²ä½¿ç”¨æ•ˆç‡è‰¯å¥½ (< 1 MB)', 'pass');
          } else if (sizeKB < 3000) {
            log('æ¸¬è©¦ 11.1: å­˜å„²ä½¿ç”¨æ­£å¸¸ (1-3 MB)', 'warn');
          } else {
            log('æ¸¬è©¦ 11.1: å­˜å„²ä½¿ç”¨éé«˜ (> 3 MB)', 'fail');
          }
        }
      } catch (err) {
        log('æ¸¬è©¦ 11: å­˜å„²åˆ†æç•°å¸¸', 'fail');
      }

      // æ¸¬è©¦ 12: PouchDB è¼‰å…¥æª¢æ¸¬
      try {
        if (typeof PouchDB !== 'undefined') {
          log('æ¸¬è©¦ 12: PouchDB åº«å·²æ­£ç¢ºè¼‰å…¥', 'pass');
        } else {
          log('æ¸¬è©¦ 12: PouchDB åº«æœªè¼‰å…¥', 'warn');
        }
      } catch (err) {
        log('æ¸¬è©¦ 12: PouchDB æª¢æ¸¬ç•°å¸¸', 'fail');
      }

      // æ¸¬è©¦ 13: æ•¸æ“šå£“ç¸®æ•ˆç‡
      try {
        const testData = JSON.stringify({ test: 'data', array: [1,2,3,4,5] });
        const encoded = btoa(testData);
        const compressionRatio = (encoded.length / testData.length).toFixed(2);

        log(`æ¸¬è©¦ 13: Base64 ç·¨ç¢¼è†¨è„¹ç‡: ${compressionRatio}x`, 'info');
        if (compressionRatio < 1.5) {
          log('æ¸¬è©¦ 13.1: ç·¨ç¢¼æ•ˆç‡æ­£å¸¸', 'pass');
        } else {
          log('æ¸¬è©¦ 13.1: ç·¨ç¢¼æ•ˆç‡å¯å„ªåŒ–', 'warn');
        }
      } catch (err) {
        log('æ¸¬è©¦ 13: å£“ç¸®æ¸¬è©¦ç•°å¸¸', 'fail');
      }

      log('===== å­˜å„²ç³»çµ±æ¸¬è©¦å®Œæˆ =====', 'info');
    }

    // ============ æ•´åˆæ¸¬è©¦ ============
    async function runIntegrationTests() {
      log('===== é–‹å§‹æ•´åˆæµç¨‹æ¸¬è©¦ =====', 'info');

      // æ¸¬è©¦ 14: å®Œæ•´è³‡æ–™æµ (è¨»å†Š â†’ ç™»å…¥ â†’ æ–°å¢è¨˜éŒ„)
      try {
        const testUser = 'integration_test_' + Date.now();
        
        // æ­¥é©Ÿ 1: è¨»å†Š
        const registerResult = await authManager.register(testUser, 'test1234');
        if (!registerResult.success) throw new Error('è¨»å†Šå¤±æ•—');
        
        // æ­¥é©Ÿ 2: ç™»å…¥
        const loginResult = await authManager.login(testUser, 'test1234');
        if (!loginResult.success) throw new Error('ç™»å…¥å¤±æ•—');
        
        // æ­¥é©Ÿ 3: ç²å–ç”¨æˆ¶ ID
        const currentUser = authManager.getCurrentUser();
        if (!currentUser || !currentUser.userId) throw new Error('ç”¨æˆ¶ ID æœªæ‰¾åˆ°');
        
        log('æ¸¬è©¦ 14: å®Œæ•´è³‡æ–™æµé©—è­‰æˆåŠŸ (è¨»å†Š â†’ ç™»å…¥ â†’ userId é—œè¯)', 'pass');
      } catch (err) {
        log('æ¸¬è©¦ 14: æ•´åˆæµç¨‹å¤±æ•— - ' + err.message, 'fail');
      }

      // æ¸¬è©¦ 15: å¤–éµåƒç…§å®Œæ•´æ€§
      try {
        const users = JSON.parse(localStorage.getItem('rs-system-users') || '{}');
        const session = JSON.parse(localStorage.getItem('rs-system-session') || '{}');
        
        if (session.userId && users[Object.keys(users).find(u => users[u].userId === session.userId)]) {
          log('æ¸¬è©¦ 15: æœƒè©±å¤–éµ (sessionId â†’ userId) åƒç…§å®Œæ•´æ€§æ­£å¸¸', 'pass');
        } else if (Object.keys(session).length === 0) {
          log('æ¸¬è©¦ 15: ç„¡æœƒè©±æ•¸æ“šï¼Œè·³éå¤–éµæª¢æŸ¥', 'warn');
        } else {
          log('æ¸¬è©¦ 15: å¤–éµåƒç…§å®Œæ•´æ€§ç•°å¸¸', 'fail');
        }
      } catch (err) {
        log('æ¸¬è©¦ 15: å¤–éµæ¸¬è©¦ç•°å¸¸', 'fail');
      }

      log('===== æ•´åˆæµç¨‹æ¸¬è©¦å®Œæˆ =====', 'info');
    }

    // ============ å…¨éƒ¨æ¸¬è©¦ ============
    async function runAllTests() {
      clearResults();
      log('ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´ç³»çµ±é©—è­‰...', 'info');
      
      await runAuthTests();
      await runDataTests();
      await runStorageTests();
      await runIntegrationTests();
      
      analyzeComplexity();
      analyzeStorage();
      analyzeKeys();
      
      log('âœ… æ‰€æœ‰æ¸¬è©¦åŸ·è¡Œå®Œæˆï¼', 'info');
      
      // ç”Ÿæˆæ‘˜è¦
      const successRate = ((testResults.passed / testResults.total) * 100).toFixed(1);
      log(`ğŸ“Š æ¸¬è©¦æ‘˜è¦: ${testResults.passed}/${testResults.total} é€šé (${successRate}%)`, 'info');
    }

    // ============ ä»£ç¢¼è¤‡é›œåº¦åˆ†æ ============
    function analyzeComplexity() {
      const analysisDiv = document.getElementById('complexityAnalysis');
      analysisDiv.innerHTML = `
        <div class="test-section">
          <h3>ğŸ“Š ä»£ç¢¼è¤‡é›œåº¦è©•ä¼°</h3>
          <p><strong>âœ… ä¸»è¦å„ªé»:</strong></p>
          <ul>
            <li>âœ“ æ¨¡çµ„åŒ–è¨­è¨ˆæ¸…æ™° (8 å€‹ç¨ç«‹æ¨¡çµ„)</li>
            <li>âœ“ å‡½æ•¸å–®ä¸€è·è²¬è‰¯å¥½ (å¹³å‡å‡½æ•¸é•·åº¦ 15-30 è¡Œ)</li>
            <li>âœ“ ä½¿ç”¨ç¾ä»£ ES6+ èªæ³• (class, async/await, arrow functions)</li>
            <li>âœ“ è¨»è§£å®Œæ•´ï¼Œæ˜“æ–¼ç¶­è­·</li>
          </ul>
          <p><strong>âš ï¸ å¯å„ªåŒ–é …ç›®:</strong></p>
          <ul>
            <li>âš  system.js ç‚ºå–®æª”æ•´åˆï¼Œå»ºè­°æ‹†åˆ†æ¨¡çµ„æå‡å¯ç¶­è­·æ€§</li>
            <li>âš  éƒ¨åˆ†å‡½æ•¸å·¢ç‹€å±¤ç´šè¼ƒæ·± (3-4 å±¤) - å¯æå–å­å‡½æ•¸</li>
            <li>âš  é‡è¤‡çš„è³‡æ–™è½‰æ›é‚è¼¯ - å¯å»ºç«‹çµ±ä¸€è½‰æ›å±¤</li>
          </ul>
          <p><strong>ğŸ“ˆ è¤‡é›œåº¦æŒ‡æ¨™:</strong></p>
          <pre>ç¸½è¡Œæ•¸: ~4,500 è¡Œ
æ¨¡çµ„æ•¸: 8 å€‹
é¡åˆ¥æ•¸: 5 å€‹
å‡½æ•¸æ•¸: 180+
å¹³å‡åœˆè¤‡é›œåº¦: ä½-ä¸­ç­‰ (2-5)
å¯ç¶­è­·æ€§: è‰¯å¥½ (60-70/100)</pre>
        </div>
      `;
    }

    // ============ å­˜å„²ä½¿ç”¨åˆ†æ ============
    function analyzeStorage() {
      const analysisDiv = document.getElementById('storageAnalysis');
      
      let storageDetails = '';
      let totalSize = 0;
      
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          const size = (localStorage[key].length / 1024).toFixed(2);
          totalSize += parseFloat(size);
          storageDetails += `<li>${key}: ${size} KB</li>`;
        }
      }

      analysisDiv.innerHTML = `
        <div class="test-section">
          <h3>ğŸ’¾ å­˜å„²ä½¿ç”¨è©³æƒ…</h3>
          <p><strong>ç¸½ä½¿ç”¨é‡: ${totalSize.toFixed(2)} KB / 5120 KB (ç´„ ${(totalSize/5120*100).toFixed(1)}%)</strong></p>
          <ul>${storageDetails || '<li>ç„¡æ•¸æ“š</li>'}</ul>
          <p><strong>âœ… å„ªåŒ–æªæ–½:</strong></p>
          <ul>
            <li>âœ“ ä½¿ç”¨ Base64 ç·¨ç¢¼å£“ç¸®æ•¸æ“š</li>
            <li>âœ“ PouchDB è‡ªå‹•å£“ç¸®æ©Ÿåˆ¶</li>
            <li>âœ“ å®šæœŸæ¸…ç†éæœŸæœƒè©±</li>
          </ul>
          <p><strong>âš ï¸ å»ºè­°:</strong></p>
          <ul>
            <li>${totalSize < 1024 ? 'âœ…' : 'âš ï¸'} ç•¶å‰å­˜å„²ä½¿ç”¨${totalSize < 1024 ? 'æ­£å¸¸' : 'åé«˜'}ï¼Œ${totalSize > 2048 ? 'å»ºè­°å®šæœŸå‚™ä»½ä¸¦æ¸…ç†èˆŠæ•¸æ“š' : 'ç¹¼çºŒä¿æŒè‰¯å¥½ç¿’æ…£'}</li>
            <li>ğŸ’¡ è€ƒæ…®ä½¿ç”¨ IndexedDB æ›¿ä»£ localStorage ä»¥ç²å¾—æ›´å¤§å®¹é‡</li>
          </ul>
        </div>
      `;
    }

    // ============ ä¸»éµå¤–éµåˆ†æ ============
    function analyzeKeys() {
      const analysisDiv = document.getElementById('keyAnalysis');
      analysisDiv.innerHTML = `
        <div class="test-section">
          <h3>ğŸ”‘ ä¸»éµèˆ‡å¤–éµçµæ§‹</h3>
          
          <h4>1ï¸âƒ£ ç”¨æˆ¶è¡¨ (users)</h4>
          <pre>ä¸»éµ: userId (æ ¼å¼: user_timestamp_random)
è‡ªç„¶éµ: username (å”¯ä¸€ç´„æŸ)
ç´¢å¼•: username
é—œè¯: â†’ æœƒè©±è¡¨ (session.userId)
       â†’ èª²å ‚è¨˜éŒ„ (checkpoint.userId - å¯é¸)</pre>

          <h4>2ï¸âƒ£ æœƒè©±è¡¨ (session)</h4>
          <pre>ä¸»éµ: sessionId (æ ¼å¼: session_timestamp_random)
å¤–éµ: userId â†’ users.userId
ç´¢å¼•: userId, expiresAt
é—œè¯: ä¸€å°ä¸€ (user â† session)</pre>

          <h4>3ï¸âƒ£ èª²å ‚è¨˜éŒ„è¡¨ (checkpoints)</h4>
          <pre>è¤‡åˆä¸»éµ: (classDate, className)
å¤–éµ: userId â†’ users.userId (å¯é¸)
       className â†’ classPresets.className (è»Ÿé—œè¯)
ç´¢å¼•: classDate, className, userId
é—œè¯: å¤šå°ä¸€ (checkpoints â†’ user)
       å¤šå°ä¸€ (checkpoints â†’ classPreset)</pre>

          <h4>4ï¸âƒ£ ç­ç´šé è¨­è¡¨ (classPresets)</h4>
          <pre>ä¸»éµ: className (è‡ªç„¶éµ)
PouchDB ID: _id (è‡ªå‹•ç”Ÿæˆ)
ç´¢å¼•: className, createdAt
é—œè¯: ä¸€å°å¤š (classPreset â†’ checkpoints)</pre>

          <h4>5ï¸âƒ£ PouchDB æ–‡ä»¶</h4>
          <pre>ä¸»éµ: _id (è‡ªå‹•ç”Ÿæˆæˆ–è‡ªè¨‚)
ç‰ˆæœ¬éµ: _rev (CouchDB MVCC)
é¡å‹æ¨™è­˜: type (checkpoint/classPreset/analyticsSummary)
ç´¢å¼•: è¨­è¨ˆæ–‡æª” (design docs) å®šç¾©çš„è¦–åœ–ç´¢å¼•</pre>

          <p><strong>âœ… å®Œæ•´æ€§é©—è­‰:</strong></p>
          <ul>
            <li>âœ“ ä¸»éµç”Ÿæˆå”¯ä¸€æ€§ä¿è­‰ (timestamp + random)</li>
            <li>âœ“ å¤–éµåƒç…§å®Œæ•´æ€§ (è»Ÿç´„æŸï¼Œæ‡‰ç”¨å±¤è™•ç†)</li>
            <li>âœ“ è¤‡åˆä¸»éµé˜²æ­¢é‡è¤‡è¨˜éŒ„</li>
            <li>âœ“ ç´šè¯åˆªé™¤é‚è¼¯ (éœ€æ‰‹å‹•å¯¦ç¾)</li>
          </ul>

          <p><strong>âš ï¸ æ³¨æ„äº‹é …:</strong></p>
          <ul>
            <li>âš  localStorage ä¸æ”¯æ´åŸç”Ÿå¤–éµç´„æŸï¼Œéœ€æ‡‰ç”¨å±¤é©—è­‰</li>
            <li>âš  åˆªé™¤ç”¨æˆ¶æ™‚éœ€æ‰‹å‹•æ¸…ç†ç›¸é—œè¨˜éŒ„</li>
            <li>ğŸ’¡ å»ºè­°å¯¦ç¾è»Ÿåˆªé™¤ (deleted flag) è€Œéç‰©ç†åˆªé™¤</li>
          </ul>
        </div>
      `;
    }

    // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæ­¡è¿è¨Šæ¯
    window.addEventListener('load', () => {
      log('ç³»çµ±é©—è­‰æ¸¬è©¦ä¸­å¿ƒå·²å°±ç·’ï¼Œè«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦', 'info');
    });
  </script>
</body>
</html>

# PR #8 和 #9 手動合併記錄

**日期**：2026年2月16日
**處理人**：GitHub Copilot Agent
**相關 PR**:
- PR #8: Fix - Add ES module support for Vite bundling
- PR #9: PLAN-A2 - Enable Creator test mode for classroom records

---

## 📋 執行摘要

本次手動合併作業針對兩個包含有價值代碼改動但同時混入大量不必要文件（如 `node_modules/`）的 Pull Request。由於直接合併會導致倉庫污染（超過 140 萬行新增代碼），因此採用手動提取核心改動的方式，保持 Git 歷史清晰且倉庫體積合理。

---

## 🔧 PR #8: 添加 ES Module 支援修復 Vite 構建問題

### 問題描述

**背景**：GitHub Pages 部署後出現 JS 文件 404 錯誤，導致頁面無法正常運行。

**根本原因**：Vite 打包工具在構建時會忽略所有未標記為 `type="module"` 的 script 標籤，導致 HTML 中引用的 JS 文件未被打包到 `dist/` 目錄，最終在生產環境中出現 404 錯誤。

**影響範圍**：
- `login.html` 和 `index.html` 中的內部 JS 文件無法加載
- LOGIN_MANAGER、STORAGE_MANAGER 等全局對象未定義
- 整個系統無法運行

### 解決方案

**方案選擇**：將所有內部 JavaScript 文件的 script 標籤改為 ES Module 模式。

**優點**：
- ✅ Vite 能正確識別並打包這些文件
- ✅ ES Module 自動延遲執行（defer 行為）
- ✅ 符合現代 JavaScript 最佳實踐
- ✅ 支持更好的代碼分割和樹搖優化

**注意事項**：
- 外部 CDN 腳本（如 PouchDB）保持原有 `defer` 屬性，不改為 `type="module"`
- ES Module 作用域隔離，需要顯式綁定到 `window` 對象以提供全局訪問

### 核心改動文件

1. **`.gitignore`** - 添加構建產物排除規則
   - `node_modules/`, `package-lock.json`, `dist/`, `.vite/`

2. **`login.html`** - 將 `defer` 改為 `type="module"`

3. **`index.html`** - 將內部 JS 文件改為 `type="module"`（外部 CDN 保持 `defer`）

4. **`system.js`** - 添加 ES Module 全局綁定
   - 綁定 7 個全局對象到 `window`

*詳細代碼改動請參考 PR #10 的 Files Changed*

---

## 🎯 PR #9: 啟用 Creator 測試模式

### 問題描述

**背景**：Creator 角色帳號之前被完全阻止建立課堂記錄，但實際需要測試功能時這個限制過於嚴格。

**需求變更**：
1. 允許 Creator 角色建立測試記錄（標記為測試模式）
2. 在介面上明確顯示測試模式狀態
3. 移除已廢棄的「課堂語言」欄位

### 解決方案

**方案設計**：
1. **Creator 測試模式**：檢測 `currentUser.role === 'creator'` 時啟用測試模式
2. **記錄標記**：在數據中添加 `creatorTestMode: true` 標誌
3. **視覺指示**：
   - 保存按鈕顯示「💾 儲存（Creator 測試模式）」
   - 記錄列表添加 🧪 emoji
   - 詳情頁顯示藍色橫幅

### 核心改動

**`system.js` 修改**:
1. 更新 Creator 權限邏輯 - 從禁止改為測試模式
2. 保存時添加 `creatorTestMode: true` 標記
3. 記錄列表添加 🧪 測試模式指示器
4. 詳情頁動態顯示藍色橫幅

*詳細代碼改動請參考 PR #10 的 Files Changed*

---

## 🔄 為何採用手動合併

### 問題分析

兩個 PR 的統計數據：
- **PR #8**: +1,450,041 行, -11 行, 3,720 個檔案變更
- **PR #9**: +1,448,491 行, -15 行, 3,712 個檔案變更

### 根本原因

1. **node_modules/ 被提交**：包含所有 npm 依賴包（數千個文件）
2. **package-lock.json 體積龐大**：鎖定版本文件包含詳細的依賴關係圖
3. **構建產物混入**：`dist/` 和 `.vite/` 緩存文件

### 直接合併的風險

❌ **倉庫體積爆炸**：Git 倉庫從 ~20MB 增長到 >1GB
❌ **Git 歷史污染**：數百萬行無意義的變更記錄
❌ **審查困難**：真正的改動淹沒在依賴文件中
❌ **合併衝突風險**：未來更新依賴時容易產生大量衝突

### 手動合併的優勢

✅ **保持倉庫整潔**：只提交核心源代碼改動
✅ **清晰的 Git 歷史**：每個提交都有明確的業務意義
✅ **高效的協作**：快速的克隆和拉取
✅ **符合最佳實踐**：依賴包通過 package.json 管理，構建產物在本地生成

---

## 📊 改動統計對比

### 原 PR 改動量
| PR | 新增行數 | 刪除行數 | 檔案數 |
|----|---------|---------|--------|
| #8 | 1,450,041 | 11 | 3,720 |
| #9 | 1,448,491 | 15 | 3,712 |

### 手動合併改動量
| 提交 | 新增行數 | 刪除行數 | 檔案數 | 說明 |
|-----|---------|---------|--------|------|
| PR #8 核心改動 | ~30 | ~5 | 4 | .gitignore, login.html, index.html, system.js |
| PR #9 核心改動 | ~50 | ~20 | 2 | index.html, system.js |
| **總計** | **~80** | **~25** | **5** | **僅核心業務邏輯改動** |

**改動量減少比例**：99.99%（從 290 萬行減少到約 100 行）

---

## ✅ 結論

本次手動合併成功提取了兩個 PR 的核心代碼改動，同時避免了倉庫污染。改動已完整應用到分支，功能完全保留，Git 歷史保持清晰。

### 關鍵成果
- ✅ ES Module 支援已啟用，Vite 構建正常運作
- ✅ Creator 測試模式功能完整實現
- ✅ `.gitignore` 已更新，防止未來誤提交
- ✅ Git 倉庫保持輕量級（~20MB）

### 經驗總結
1. 在創建 PR 前必須檢查 `.gitignore` 設定
2. 使用 `git status` 確認暫存區內容再提交
3. 構建產物和依賴包絕不應該提交到倉庫
4. 發現錯誤提交時應立即採用手動合併而非直接合併

---

**文檔版本**：2.0 (精簡版)
**最後更新**：2026年2月16日
**相關文件**：`.gitignore`, `login.html`, `index.html`, `system.js`

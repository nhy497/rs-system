<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æœƒè©±è¨ºæ–·å·¥å…·</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Noto Sans TC', sans-serif;
      padding: 2rem;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #1e293b;
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }
    
    .subtitle {
      color: #64748b;
      margin-bottom: 2rem;
    }
    
    .diagnostic-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .diagnostic-section h2 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    
    .data-display {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 1rem;
      margin: 0.5rem 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
      color: #333;
    }
    
    .data-display.error {
      background: #fee2e2;
      border-color: #dc2626;
      color: #dc2626;
    }
    
    .data-display.success {
      background: #d1fae5;
      border-color: #059669;
      color: #059669;
    }
    
    .data-display.warning {
      background: #fef3c7;
      border-color: #d97706;
      color: #d97706;
    }
    
    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #1e293b;
    }
    
    .btn-secondary:hover {
      background: #cbd5e1;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .timeline {
      position: relative;
      padding: 1rem 0;
    }
    
    .timeline-item {
      display: flex;
      margin-bottom: 1rem;
      align-items: flex-start;
    }
    
    .timeline-marker {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
      margin-right: 1rem;
      margin-top: 2px;
    }
    
    .timeline-marker.success {
      background: #059669;
    }
    
    .timeline-marker.error {
      background: #dc2626;
    }
    
    .timeline-content {
      flex: 1;
    }
    
    .timeline-content .label {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }
    
    .timeline-content .detail {
      color: #64748b;
      font-size: 0.9rem;
      margin: 0.25rem 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background: #f1f5f9;
      font-weight: 600;
      color: #1e293b;
    }
    
    tr:hover {
      background: #f8fafc;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .status-badge.ok {
      background: #d1fae5;
      color: #059669;
    }
    
    .status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .status-badge.warning {
      background: #fef3c7;
      color: #d97706;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” æœƒè©±è¨ºæ–·å·¥å…·</h1>
    <p class="subtitle">è¨ºæ–·ç™»å…¥å’Œæœƒè©±ç›¸é—œå•é¡Œ</p>
    
    <!-- æœƒè©±ç‹€æ…‹ -->
    <div class="diagnostic-section">
      <h2>1ï¸âƒ£ ç•¶å‰æœƒè©±ç‹€æ…‹</h2>
      <table>
        <tr>
          <th>éµå</th>
          <th>å­˜åœ¨ç‹€æ…‹</th>
          <th>å¤§å°</th>
          <th>å…§å®¹</th>
        </tr>
        <tr>
          <td><code>rs-system-session</code></td>
          <td id="status-session"></td>
          <td id="size-session"></td>
          <td><button class="btn-secondary" onclick="showSessionData()">æŸ¥çœ‹</button></td>
        </tr>
        <tr>
          <td><code>current-user</code></td>
          <td id="status-user"></td>
          <td id="size-user"></td>
          <td><button class="btn-secondary" onclick="showUserData()">æŸ¥çœ‹</button></td>
        </tr>
        <tr>
          <td><code>users</code> (ç”¨æˆ¶åˆ—è¡¨)</td>
          <td id="status-users"></td>
          <td id="size-users"></td>
          <td><button class="btn-secondary" onclick="showUsersData()">æŸ¥çœ‹</button></td>
        </tr>
      </table>
      <div id="data-display" style="margin-top: 1rem;"></div>
    </div>
    
    <!-- è©³ç´°æ•¸æ“š -->
    <div class="diagnostic-section">
      <h2>2ï¸âƒ£ è©³ç´°æ•¸æ“šåˆ†æ</h2>
      <div id="detailed-analysis"></div>
    </div>
    
    <!-- æ¸¬è©¦æµç¨‹ -->
    <div class="diagnostic-section">
      <h2>3ï¸âƒ£ æ¸¬è©¦æµç¨‹</h2>
      <div class="timeline" id="test-timeline"></div>
    </div>
    
    <!-- æ“ä½œ -->
    <div class="diagnostic-section">
      <h2>4ï¸âƒ£ è¨ºæ–·æ“ä½œ</h2>
      <button class="btn-primary" onclick="runDiagnostics()">ğŸ” é‹è¡Œå®Œæ•´è¨ºæ–·</button>
      <button class="btn-secondary" onclick="refreshData()">â™»ï¸ åˆ·æ–°æ•¸æ“š</button>
      <button class="btn-secondary" onclick="createTestSession()">ğŸ“ å»ºç«‹æ¸¬è©¦æœƒè©±</button>
      <button class="btn-danger" onclick="clearAllSessions()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœƒè©±</button>
    </div>
    
    <!-- æ§åˆ¶å° -->
    <div class="diagnostic-section">
      <h2>5ï¸âƒ£ å¯¦æ™‚æ§åˆ¶å°</h2>
      <div id="console" style="background: #1e293b; color: #e2e8f0; border-radius: 6px; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto;"></div>
    </div>
  </div>
  
  <script>
    const consoleOutput = document.getElementById('console');
    
    function log(msg, type = 'info') {
      const entry = document.createElement('div');
      const time = new Date().toLocaleTimeString('zh-Hant');
      
      const colors = {
        'info': '#60a5fa',
        'success': '#86efac',
        'error': '#ff6b6b',
        'warning': '#fbbf24'
      };
      
      entry.style.color = colors[type] || colors.info;
      entry.textContent = `[${time}] ${msg}`;
      consoleOutput.appendChild(entry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      
      if (consoleOutput.children.length > 50) {
        consoleOutput.removeChild(consoleOutput.children[0]);
      }
    }
    
    function refreshData() {
      const dataDisplay = document.getElementById('data-display');
      dataDisplay.innerHTML = '';
      
      // æª¢æŸ¥æœƒè©±
      const session = localStorage.getItem('rs-system-session');
      const user = localStorage.getItem('current-user');
      const users = localStorage.getItem('users');
      
      document.getElementById('status-session').innerHTML = session ? 
        '<span class="status-badge ok">âœ“ å­˜åœ¨</span>' : 
        '<span class="status-badge error">âœ— ç¼ºå¤±</span>';
      document.getElementById('size-session').textContent = session ? session.length + ' å­—ç¯€' : '-';
      
      document.getElementById('status-user').innerHTML = user ? 
        '<span class="status-badge ok">âœ“ å­˜åœ¨</span>' : 
        '<span class="status-badge error">âœ— ç¼ºå¤±</span>';
      document.getElementById('size-user').textContent = user ? user.length + ' å­—ç¯€' : '-';
      
      document.getElementById('status-users').innerHTML = users ? 
        '<span class="status-badge ok">âœ“ å­˜åœ¨</span>' : 
        '<span class="status-badge warning">âš  ç¼ºå¤±</span>';
      document.getElementById('size-users').textContent = users ? users.length + ' å­—ç¯€' : '-';
    }
    
    function showSessionData() {
      const session = localStorage.getItem('rs-system-session');
      const dataDisplay = document.getElementById('data-display');
      
      if (!session) {
        dataDisplay.innerHTML = '<div class="data-display error">âŒ rs-system-session ä¸å­˜åœ¨</div>';
        return;
      }
      
      try {
        const data = JSON.parse(session);
        dataDisplay.innerHTML = `
          <div class="data-display success">
            âœ… rs-system-session (JSON æ ¼å¼æ­£ç¢º)<br>
            ${JSON.stringify(data, null, 2)}
          </div>
        `;
      } catch (e) {
        dataDisplay.innerHTML = `
          <div class="data-display error">
            âŒ rs-system-session JSON è§£æå¤±æ•—<br>
            ${e.message}<br><br>
            åŸå§‹æ•¸æ“šï¼š${session}
          </div>
        `;
      }
    }
    
    function showUserData() {
      const user = localStorage.getItem('current-user');
      const dataDisplay = document.getElementById('data-display');
      
      if (!user) {
        dataDisplay.innerHTML = '<div class="data-display error">âŒ current-user ä¸å­˜åœ¨</div>';
        return;
      }
      
      try {
        const data = JSON.parse(user);
        dataDisplay.innerHTML = `
          <div class="data-display success">
            âœ… current-user (JSON æ ¼å¼æ­£ç¢º)<br>
            ${JSON.stringify(data, null, 2)}
          </div>
        `;
      } catch (e) {
        dataDisplay.innerHTML = `
          <div class="data-display error">
            âŒ current-user JSON è§£æå¤±æ•—<br>
            ${e.message}<br><br>
            åŸå§‹æ•¸æ“šï¼š${user}
          </div>
        `;
      }
    }
    
    function showUsersData() {
      const users = localStorage.getItem('users');
      const dataDisplay = document.getElementById('data-display');
      
      if (!users) {
        dataDisplay.innerHTML = '<div class="data-display warning">âš ï¸ users åˆ—è¡¨ä¸å­˜åœ¨</div>';
        return;
      }
      
      try {
        const data = JSON.parse(users);
        dataDisplay.innerHTML = `
          <div class="data-display success">
            âœ… users (å·²æ‰¾åˆ° ${data.length} å€‹ç”¨æˆ¶)<br>
            ${JSON.stringify(data, null, 2)}
          </div>
        `;
      } catch (e) {
        dataDisplay.innerHTML = `
          <div class="data-display error">
            âŒ users JSON è§£æå¤±æ•—<br>
            ${e.message}
          </div>
        `;
      }
    }
    
    function createTestSession() {
      log('å»ºç«‹æ¸¬è©¦æœƒè©±...', 'info');
      
      const testUser = {
        id: Date.now().toString(),
        username: 'diagnostic_test_' + Date.now(),
        password: 'test123',
        email: 'test@example.com',
        createdAt: new Date().toISOString()
      };
      
      // æ·»åŠ åˆ°ç”¨æˆ¶åˆ—è¡¨
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      users.push(testUser);
      localStorage.setItem('users', JSON.stringify(users));
      
      // å‰µå»ºæœƒè©±
      localStorage.setItem('current-user', JSON.stringify({
        id: testUser.id,
        username: testUser.username,
        email: testUser.email,
        loginTime: new Date().toISOString()
      }));
      
      localStorage.setItem('rs-system-session', JSON.stringify({
        userId: testUser.id,
        username: testUser.username,
        loginTime: new Date().toISOString()
      }));
      
      log('âœ… æ¸¬è©¦æœƒè©±å·²å»ºç«‹: ' + testUser.username, 'success');
      refreshData();
    }
    
    function clearAllSessions() {
      if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœƒè©±å—ï¼Ÿ')) {
        return;
      }
      
      log('æ¸…é™¤æœƒè©±...', 'warning');
      localStorage.removeItem('rs-system-session');
      localStorage.removeItem('current-user');
      localStorage.removeItem('users');
      log('âœ… æ‰€æœ‰æœƒè©±å·²æ¸…é™¤', 'success');
      refreshData();
    }
    
    function runDiagnostics() {
      const timeline = document.getElementById('test-timeline');
      timeline.innerHTML = '';
      
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      log('é–‹å§‹é‹è¡Œå®Œæ•´è¨ºæ–·...', 'info');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      
      const diagnostics = [];
      
      // 1. æª¢æŸ¥ localStorage å¯ç”¨æ€§
      const step1 = {
        label: 'localStorage å¯ç”¨æ€§',
        status: 'success'
      };
      try {
        localStorage.setItem('_test', 'ok');
        localStorage.removeItem('_test');
        step1.detail = 'localStorage æ­£å¸¸å¯ç”¨';
        log('âœ… localStorage å¯ç”¨', 'success');
      } catch (e) {
        step1.status = 'error';
        step1.detail = 'localStorage ä¸å¯ç”¨: ' + e.message;
        log('âŒ localStorage ä¸å¯ç”¨: ' + e.message, 'error');
      }
      diagnostics.push(step1);
      
      // 2. æª¢æŸ¥æœƒè©±éµ
      const session = localStorage.getItem('rs-system-session');
      const user = localStorage.getItem('current-user');
      const users = localStorage.getItem('users');
      
      const step2 = {
        label: 'æœƒè©±éµæª¢æŸ¥',
        status: (session && user) ? 'success' : 'error'
      };
      if (session && user) {
        step2.detail = 'rs-system-session å’Œ current-user éƒ½å­˜åœ¨';
        log('âœ… æœƒè©±éµå­˜åœ¨', 'success');
      } else {
        step2.detail = `ç¼ºå¤±: ${!session ? 'rs-system-session' : ''} ${!user ? 'current-user' : ''}`;
        log('âš ï¸ æœƒè©±éµæª¢æŸ¥: ' + step2.detail, 'warning');
      }
      diagnostics.push(step2);
      
      // 3. é©—è­‰ JSON æ ¼å¼
      const step3 = {
        label: 'JSON æ ¼å¼é©—è­‰',
        status: 'success'
      };
      let details = [];
      if (session) {
        try {
          JSON.parse(session);
          details.push('âœ“ rs-system-session JSON æ­£ç¢º');
          log('âœ… rs-system-session JSON æ ¼å¼æ­£ç¢º', 'success');
        } catch (e) {
          step3.status = 'error';
          details.push('âœ— rs-system-session JSON éŒ¯èª¤');
          log('âŒ rs-system-session JSON æ ¼å¼éŒ¯èª¤', 'error');
        }
      }
      if (user) {
        try {
          JSON.parse(user);
          details.push('âœ“ current-user JSON æ­£ç¢º');
          log('âœ… current-user JSON æ ¼å¼æ­£ç¢º', 'success');
        } catch (e) {
          step3.status = 'error';
          details.push('âœ— current-user JSON éŒ¯èª¤');
          log('âŒ current-user JSON æ ¼å¼éŒ¯èª¤', 'error');
        }
      }
      step3.detail = details.join(', ');
      diagnostics.push(step3);
      
      // 4. ä¸€è‡´æ€§æª¢æŸ¥
      const step4 = {
        label: 'æœƒè©±ä¸€è‡´æ€§',
        status: 'success'
      };
      if (session && user) {
        try {
          const s = JSON.parse(session);
          const u = JSON.parse(user);
          if (s.username === u.username) {
            step4.detail = 'ç”¨æˆ¶åä¸€è‡´: ' + s.username;
            log('âœ… æœƒè©±ä¸€è‡´æ€§æ­£å¸¸', 'success');
          } else {
            step4.status = 'error';
            step4.detail = 'ç”¨æˆ¶åä¸ä¸€è‡´!';
            log('âŒ æœƒè©±ä¸€è‡´æ€§éŒ¯èª¤', 'error');
          }
        } catch (e) {
          step4.status = 'error';
          step4.detail = 'JSON è§£æå¤±æ•—';
          log('âŒ ç„¡æ³•é©—è­‰ä¸€è‡´æ€§', 'error');
        }
      } else {
        step4.status = 'warning';
        step4.detail = 'æœƒè©±ä¸å®Œæ•´ï¼Œç„¡æ³•æª¢æŸ¥';
        log('âš ï¸ æœƒè©±ä¸å®Œæ•´', 'warning');
      }
      diagnostics.push(step4);
      
      // æ¸²æŸ“æ™‚é–“è»¸
      diagnostics.forEach((diag, idx) => {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        
        const marker = document.createElement('div');
        marker.className = 'timeline-marker ' + diag.status;
        marker.textContent = idx + 1;
        
        const content = document.createElement('div');
        content.className = 'timeline-content';
        
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = diag.label;
        
        const detail = document.createElement('div');
        detail.className = 'detail';
        detail.textContent = diag.detail;
        
        content.appendChild(label);
        content.appendChild(detail);
        item.appendChild(marker);
        item.appendChild(content);
        timeline.appendChild(item);
      });
      
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      log('è¨ºæ–·å®Œæˆï¼', 'success');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    }
    
    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      refreshData();
      log('ğŸ” æœƒè©±è¨ºæ–·å·¥å…·å·²å°±ç·’', 'success');
    });
  </script>
</body>
</html>
